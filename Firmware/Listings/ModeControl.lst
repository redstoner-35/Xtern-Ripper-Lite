C51 COMPILER V9.60.0.0   MODECONTROL                                                       11/09/2024 20:18:37 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MODECONTROL
OBJECT MODULE PLACED IN .\Objects\ModeControl.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Logic\ModeControl.c OMF2 OPTIMIZE(9,SPEED) BROWSE INCDIR(.\include;.\Std
                    -Driver\inc;.\Hardware) DEBUG PRINT(.\Listings\ModeControl.lst) TABS(2) OBJECT(.\Objects\ModeControl.obj)

line level    source

   1          #include "ModeControl.h"
   2          #include "LEDMgmt.h"
   3          #include "SideKey.h"
   4          #include "BattDisplay.h"
   5          #include "OutputChannel.h"
   6          #include "RampConfig.h"
   7          #include "ADCCfg.h"
   8          
   9          //µ²Î»½á¹¹Ìå
  10          code ModeStrDef ModeSettings[ModeTotalDepth]=
  11            {
  12              //¹Ø»ú×´Ì¬
  13              {
  14              Mode_OFF,
  15              0,
  16              0,  //µçÁ÷0mA
  17              0,  //¹Ø»ú×´Ì¬ãÐÖµÎª0Ç¿ÖÆ½â³ý¾¯±¨
  18              true,
  19              false
  20              }, 
  21              //³ö´íÁË
  22              {
  23              Mode_Fault,
  24              0,
  25              0,  //µçÁ÷0mA
  26              0,
  27              false,
  28              false
  29              }, 
  30              //ÔÂ¹â
  31              {
  32              Mode_Moon,
  33              350,  //Ä¬ÈÏ350mAµçÁ÷
  34              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
  35              2800,  //2.8V¹Ø¶Ï
  36              false, //ÔÂ¹âµµÓÐ×¨ÓÃÈë¿Ú£¬ÎÞÐè´ø¼ÇÒä
  37              false
  38              },  
  39              //µÍÁÁ
  40              {
  41              Mode_Low,
  42              800,  //800mAµçÁ÷
  43              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
  44              2900,  //2.8V¹Ø¶Ï
  45              true,
  46              false
  47              },
  48              //ÖÐÁÁ
  49              {
  50              Mode_Mid,
  51              1500,  //1500mAµçÁ÷
  52              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
  53              3000,  //3V¹Ø¶Ï
  54              true,
C51 COMPILER V9.60.0.0   MODECONTROL                                                       11/09/2024 20:18:37 PAGE 2   

  55              false
  56              },  
  57              //ÖÐ¸ßÁÁ
  58              {
  59              Mode_MHigh,
  60              3000,  //3000mAµçÁ÷
  61              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
  62              3050,  //3.05V¹Ø¶Ï
  63              true,
  64              true
  65              },  
  66              //¸ßÁÁ
  67              {
  68              Mode_High,
  69              7500,  //7500mAµçÁ÷
  70              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
  71              3100,  //3.1V¹Ø¶Ï
  72              true,
  73              true
  74              },  
  75              //¼«ÁÁ
  76              {
  77              Mode_Turbo,
  78              14000,  //14000mAµçÁ÷
  79              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
  80              3200,  //3.2V¹Ø¶Ï
  81              false, //¼«ÁÁ²»ÄÜ´ø¼ÇÒä
  82              true
  83              },  
  84              //±¬ÉÁ    
  85              {
  86              Mode_Strobe,
  87              10000,  //10000mAµçÁ÷
  88              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
  89              3000,  //3.0V¹Ø¶Ï
  90              false, //±¬ÉÁ²»ÄÜ´ø¼ÇÒä
  91              true
  92              }, 
  93              //ÎÞ¼«µ÷¹â    
  94              {
  95              Mode_Ramp,
  96              7500,  //7500mAµçÁ÷×î´ó
  97              500,   //×îÐ¡500mA
  98              3000,  //3.0V¹Ø¶Ï
  99              false, //²»ÄÜ´ø¼ÇÒä  
 100              true
 101              }, 
 102              //SOS
 103              {
 104              Mode_SOS,
 105              10000,  //10000mAµçÁ÷
 106              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
 107              3000,  //3.0V¹Ø¶Ï
 108              false,  //SOS²»ÄÜ´ø¼ÇÒä
 109              true
 110              }, 
 111            };
 112          
 113          //È«¾Ö±äÁ¿(µ²Î»)
 114          ModeStrDef *CurrentMode; //µ²Î»½á¹¹ÌåÖ¸Õë
 115          xdata ModeIdxDef LastMode; //¿ª»úÎªµÍÁÁ
 116          RampConfigDef RampCfg; //ÎÞ¼«µ÷¹âÅäÖÃ   
C51 COMPILER V9.60.0.0   MODECONTROL                                                       11/09/2024 20:18:37 PAGE 3   

 117          xdata MoonLightBrightnessDef MoonCfg;  //ÔÂ¹âÄ£Ê½ÅäÖÃ
 118            
 119          //È«¾Ö±äÁ¿(×´Ì¬Î»)
 120          bit IsRampEnabled; //ÊÇ·ñ¿ªÆôÎÞ¼«µ÷¹â
 121          bit IsLocked; //Ëø¶¨Ö¸Ê¾
 122          bit IsTacMode; //¿ªÆôÕ½ÊõÄ£Ê½
 123          bit IsEnableMoonConfigMode; //´ò¿ªÔÂ¹âÅäÖÃÄ£Ê½
 124          static xdata SOSStateDef SOSState; //È«¾Ö±äÁ¿×´Ì¬Î»
 125          xdata FaultCodeDef ErrCode; //´íÎó´úÂë  
 126          xdata float TargetCurrent; //µ±Ç°Ä¿±êµçÁ÷ 
 127            
 128          //Èí¼þ¼ÆÊ±±äÁ¿
 129          xdata char BattAlertTimer=0; //µç³ØµÍµçÑ¹¸æ¾¯µ÷µµ
 130          xdata char HoldChangeGearTIM=0; //µ²Î»Ä£Ê½ÏÂ³¤°´»»µ²
 131          xdata char DisplayLockedTIM=0; //Ëø¶¨ºÍÕ½ÊõÄ£Ê½½øÈëÍË³öÏÔÊ¾ 
 132          xdata char ClickHoldReverseGearTIM=0; //µ²Î»Ä£Ê½ÏÂµ¥»÷+³¤°´µ¹Ïò»»µ²
 133          xdata char MoonCfgTIM=0; //ÔÂ¹âµ²Î»ÅäÖÃ¼ÆÊ±
 134          xdata char SOSTIM=0;  //SOS¼ÆÊ±
 135            
 136          //³õÊ¼»¯Ä£Ê½×´Ì¬»ú
 137          void ModeFSMInit(void)
 138          {
 139   1        RampCfg.RampMaxDisplayTIM=0;
 140   1        ReadRampConfig(); //´ÓEEPROMÄÚ¶ÁÈ¡ÎÞ¼«µ÷¹âÅäÖÃ
 141   1        //µ²Î»Ä£Ê½ÅäÖÃ
 142   1        SOSState=SOSState_Prepare; //SOS×´Ì¬»úÖØÖÃÎª³õÊ¼Öµ
 143   1        LastMode=Mode_Low;
 144   1        ErrCode=Fault_None; //Ã»ÓÐ¹ÊÕÏ
 145   1        CurrentMode=&ModeSettings[0]; //¼ÇÒäÖØÖÃÎªµÚÒ»¸öµµ
 146   1        IsLocked=0; //¹Ø±ÕËø¶¨
 147   1        IsTacMode=0; //ÍË³öÕ½ÊõÄ£Ê½
 148   1      } 
 149          
 150          //SOS´¦ÀíÄ£¿é
 151          static int SOSFSM(void)
 152          {
 153   1        int buf;
 154   1        switch(SOSState)
 155   1          {
 156   2          //×¼±¸½×¶Î
 157   2          case SOSState_Prepare:
 158   2             SOSTIM=(3*SOSDotTime*2)-1;
 159   2             SOSState=SOSState_3Dot;
 160   2             break;
 161   2          //µÚÒ»´ÎÈýµã
 162   2          case SOSState_3Dot:
 163   2             buf=SOSTIM%(SOSDotTime*2); //¸ù¾Ý²ÎÊýÉèÖÃ»»Ëã¼ÆÊ±Æ÷µÄ×ÜÊ±¼ä
 164   2             if(buf>(SOSDotTime-1))return CurrentMode->Current; //µ±Ç°×´Ì¬ÐèÒªLEDµçÁ÷£¬·µ»ØÄ¿±êµçÁ÷Öµ   
 165   2             if(SOSTIM==0) //ÏÔÊ¾½áÊø
 166   2               {
 167   3               SOSTIM=SOSGapTime; 
 168   3               SOSState=SOSState_3DotWait;  //½øÈëÑÓÊ±µÈ´ý½×¶Î
 169   3               }
 170   2             break;
 171   2          //Èýµã½áÊøºóµÄµÈ´ýÑÓÊ±½×¶Î
 172   2          case SOSState_3DotWait:
 173   2             if(SOSTIM>0)break;
 174   2             SOSTIM=(3*SOSDashTime*2)-1;
 175   2             SOSState=SOSState_3Dash;
 176   2             break;
 177   2          //Èý»®
 178   2          case SOSState_3Dash:
C51 COMPILER V9.60.0.0   MODECONTROL                                                       11/09/2024 20:18:37 PAGE 4   

 179   2             buf=SOSTIM%(SOSDashTime*2); //¸ù¾Ý²ÎÊýÉèÖÃ»»Ëã¼ÆÊ±Æ÷µÄ×ÜÊ±¼ä
 180   2             if(buf>(SOSDashTime-1))return CurrentMode->Current; //µ±Ç°×´Ì¬ÐèÒªLEDµçÁ÷£¬·µ»ØÄ¿±êµçÁ÷Öµ  
 181   2             if(SOSTIM==0) //ÏÔÊ¾½áÊø
 182   2               {
 183   3               SOSTIM=SOSGapTime; 
 184   3               SOSState=SOSState_3DashWait;  //½øÈëÑÓÊ±µÈ´ý½×¶Î
 185   3               }
 186   2             break;     
 187   2          //Èý»®½áÊøºóµÄµÈ´ýÑÓÊ±½×¶Î
 188   2          case SOSState_3DashWait:
 189   2             if(SOSTIM>0)break;
 190   2             SOSTIM=(3*SOSDotTime*2)-1;
 191   2             SOSState=SOSState_3DotAgain;
 192   2             break;   
 193   2          //µÚ¶þ´ÎÈýµã
 194   2          case SOSState_3DotAgain:
 195   2             buf=SOSTIM%(SOSDotTime*2); //¸ù¾Ý²ÎÊýÉèÖÃ»»Ëã¼ÆÊ±Æ÷µÄ×ÜÊ±¼ä
 196   2             if(buf>(SOSDotTime-1))return CurrentMode->Current; //µ±Ç°×´Ì¬ÐèÒªLEDµçÁ÷£¬·µ»ØÄ¿±êµçÁ÷Öµ   
 197   2             if(SOSTIM==0) //ÏÔÊ¾½áÊø
 198   2               {
 199   3               SOSTIM=SOSFinishGapTime; 
 200   3               SOSState=SOSState_Wait;  //½øÈëÑÓÊ±µÈ´ý½×¶Î
 201   3               }
 202   2             break;   
 203   2          //±¾ÂÖÐÅºÅ·¢³öÍê±Ï£¬µÈ´ý
 204   2          case SOSState_Wait: 
 205   2             if(SOSTIM>0)break;
 206   2             SOSState=SOSState_Prepare; //»Øµ½×¼±¸×´Ì¬
 207   2             break;
 208   2          }
 209   1        //ÆäÓàÇé¿ö·µ»Ø-1
 210   1        return -1;
 211   1      }
 212          
 213          //ÔÂ¹âµ²Î»Ñ­»·ÅäÖÃ¹¦ÄÜ
 214          void MoonConfigHandler(void)
 215          {
 216   1        int buf;
 217   1        //·ÇÔÂ¹âÄ£Ê½»òÕßÅäÖÃÎ´´ò¿ª£¬½ûÖ¹ÅäÖÃ
 218   1        if(!IsEnableMoonConfigMode||CurrentMode->ModeIdx!=Mode_Moon)MoonCfgTIM=0; 
 219   1        //ÆôÓÃÅäÖÃÄ£Ê½£¬Ñ­»·²Ù×÷
 220   1        else
 221   1          {
 222   2          MoonCfgTIM++;
 223   2          if(MoonCfgTIM<16)return;
 224   2          MoonCfgTIM=0;
 225   2          //¿ªÊ¼µÝÔö²¢·´¸´Ñ­»·ÔÂ¹âµ²Î»µÄindexÒÔ¹¹³ÉÑ­»·
 226   2          buf=(int)MoonCfg;
 227   2          if(buf<(int)MoonLight_UsingModeDef)buf++;
 228   2          else buf=0;
 229   2          MoonCfg=(MoonLightBrightnessDef)buf; //·´¸´Ñ­»·index
 230   2          }
 231   1      }
 232          
 233          //µ²Î»×´Ì¬»úËùÐèµÄÈí¼þ¶¨Ê±Æ÷´¦Àí
 234          void ModeFSMTIMHandler(void)
 235          {
 236   1        char buf;
 237   1        //SOS¶¨Ê±Æ÷
 238   1        if(SOSTIM>0)SOSTIM--;
 239   1        //ÎÞ¼«µ÷¹âÌáÊ¾¶¨Ê±Æ÷
 240   1        if(RampCfg.CfgSavedTIM<32)RampCfg.CfgSavedTIM++;
C51 COMPILER V9.60.0.0   MODECONTROL                                                       11/09/2024 20:18:37 PAGE 5   

 241   1        if(RampCfg.RampMaxDisplayTIM>0)RampCfg.RampMaxDisplayTIM--;
 242   1        //Ëø¶¨²Ù×÷ÌáÊ¾¼ÆÊ±Æ÷
 243   1        if(DisplayLockedTIM>0)DisplayLockedTIM--;
 244   1        //¼ì²â¶¨Ê±Æ÷×´Ì¬
 245   1        if(BattAlertTimer&0x80)
 246   1          {
 247   2          buf=BattAlertTimer&0x7F; //È¡³öTIMÖµ
 248   2          BattAlertTimer&=0x80; //È¥³ýµôÔ­Ê¼µÄTIMÖµ
 249   2          if(buf<(BatteryAlertDelay+1))buf++;
 250   2          BattAlertTimer|=buf; //°ÑÊýÖµÐ´»ØÈ¥
 251   2          }
 252   1        else BattAlertTimer=0; //Çå³ýbuf  
 253   1      }
 254          
 255          //µ²Î»Ìø×ª
 256          int SwitchToGear(ModeIdxDef TargetMode)
 257            {
 258   1        int i;
 259   1        extern xdata float VBattBeforeTurbo;
 260   1        ModeIdxDef BeforeMode=CurrentMode->ModeIdx; //´æ´¢µ±Ç°Ä£Ê½  
 261   1        for(i=0;i<ModeTotalDepth;i++)if(ModeSettings[i].ModeIdx==TargetMode)
 262   1          {
 263   2          SOSState=SOSState_Prepare; //Ã¿´Î»»µ²¶¼°ÑSOS×´Ì¬»úÖØÖÃÎª³õÊ¼Öµ
 264   2          CurrentMode=&ModeSettings[i]; //ÕÒµ½Æ¥Åäindex£¬¸³Öµ½á¹¹Ìå
 265   2          if(TargetMode==Mode_Turbo&&BeforeMode!=Mode_Turbo)VBattBeforeTurbo=Data.RawBattVolt; //ÇÐ»»µ½turboÄ£Ê½Ê±
             -½øÐÐ²ÉÑù
 266   2          return 0;
 267   2          }
 268   1        //É¶Ò²Ã»ÕÒµ½£¬³ö´í
 269   1        return 1;
 270   1        }
 271          
 272          //³¤°´¹Ø»úº¯Êý  
 273          void ReturnToOFFState(void)
 274            {
 275   1        if(CurrentMode->ModeIdx==Mode_OFF)return; //¹Ø»ú×´Ì¬²»Ö´ÐÐ    
 276   1        if(CurrentMode->IsModeHasMemory)LastMode=CurrentMode->ModeIdx; //´æ´¢¹Ø»úÇ°µÄµ²Î»
 277   1        SwitchToGear(Mode_OFF); //Ç¿ÖÆÌø»Øµ½¹Ø»úµ²Î»
 278   1        } 
 279            
 280          //µÍµçÁ¿±£»¤º¯Êý
 281          static void BatteryLowAlertProcess(bool IsNeedToShutOff,ModeIdxDef ModeJump)
 282            {
 283   1        char time,Thr;
 284   1        if(!IsBatteryAlert&&!IsBatteryFault)//Ã»ÓÐ¸æ¾¯
 285   1          {
 286   2          BattAlertTimer=0;
 287   2          return;
 288   2          }
 289   1        if(BattAlertTimer==0)BattAlertTimer=0x80;//¶¨Ê±Æ÷Æô¶¯
 290   1        time=BattAlertTimer&0x7F; //»ñÈ¡µ±Ç°µÄ¼ÆÊ±Öµ
 291   1        if(!IsBatteryFault)Thr=BatteryAlertDelay;
 292   1        else Thr=2;
 293   1        //µç³ØµçÁ¿ÑÏÖØ¹ýµÍ
 294   1        if(IsNeedToShutOff&&IsBatteryFault&&time>=3)ReturnToOFFState(); //µç³ØµçÑ¹µÍÓÚ¹Ø»úãÐÖµ´óÓÚ0.5Ãë£¬Á¢¼´¹Ø±Õ
 295   1        //´¥·¢¶¯×÷
 296   1        else if(time>Thr)
 297   1           {
 298   2           BattAlertTimer=0x80;//ÖØÖÃ¶¨Ê±Æ÷
 299   2           SwitchToGear(ModeJump); //¸´Î»µ½Ö¸¶¨µ²Î»
 300   2           }
 301   1        } 
C51 COMPILER V9.60.0.0   MODECONTROL                                                       11/09/2024 20:18:37 PAGE 6   

 302          
 303          //³¤°´»»µ²µÄ¼ä¸ôÃüÁîÉú³É
 304          void HoldSwitchGearCmdHandler(void)
 305            {
 306   1        char buf;
 307   1        if(!getSideKeyHoldEvent()||CurrentMode->ModeIdx==Mode_OFF)HoldChangeGearTIM=0; //°´¼üËÉ¿ª»òÕßÊÇ¹Ø»ú×´Ì¬£¬
             -¼ÆÊ±Æ÷¸´Î»
 308   1        else
 309   1          {
 310   2          buf=HoldChangeGearTIM&0x3F; //È¡³öTIMÖµ
 311   2          if(buf==0&&!(HoldChangeGearTIM&0x40))HoldChangeGearTIM|=0x80; //Áî×î¸ßÎ»Îª1Ö¸Ê¾»»µ²¿ÉÒÔ¼ÌÐø
 312   2          HoldChangeGearTIM&=0xC0; //È¥³ýµôÔ­Ê¼µÄTIMÖµ
 313   2          if(buf<HoldSwitchDelay&&!(HoldChangeGearTIM&0x40))buf++;
 314   2          else buf=0;  //Ê±¼äµ½£¬ÇåÁã½á¹û
 315   2          HoldChangeGearTIM|=buf; //°ÑÊýÖµÐ´»ØÈ¥
 316   2          }
 317   1        //µ¥»÷+³¤°´µ¹»»
 318   1        if(!getSideKeyClickAndHoldEvent()||CurrentMode->ModeIdx==Mode_OFF)ClickHoldReverseGearTIM=0;  //°´¼üËÉ¿ª»
             -òÕßÊÇ¹Ø»ú×´Ì¬£¬¼ÆÊ±Æ÷¸´Î» 
 319   1        else
 320   1          {
 321   2          buf=ClickHoldReverseGearTIM&0x3F; //È¡³öTIMÖµ
 322   2          if(buf==0&&!(ClickHoldReverseGearTIM&0x40))ClickHoldReverseGearTIM|=0x80; //Áî×î¸ßÎ»Îª1Ö¸Ê¾»»µ²¿ÉÒÔ¼ÌÐø
 323   2          ClickHoldReverseGearTIM&=0xC0; //È¥³ýµôÔ­Ê¼µÄTIMÖµ
 324   2          if(buf<HoldSwitchDelay&&!(ClickHoldReverseGearTIM&0x40))buf++;
 325   2          else buf=0;  //Ê±¼äµ½£¬ÇåÁã½á¹û
 326   2          ClickHoldReverseGearTIM|=buf; //°ÑÊýÖµÐ´»ØÈ¥
 327   2          }
 328   1        } 
 329            
 330          //²à°´³¤°´»»µ²²Ù×÷Ö´ÐÐ
 331          static void SideKeySwitchGearHandler(ModeIdxDef TargetMode) 
 332            {
 333   1        if(!(HoldChangeGearTIM&0x80))return;
 334   1        HoldChangeGearTIM&=0x7F; //Çå³ý±ê¼ÇÎ»±ê¼Ç±¾´Î»»µ²Íê³É
 335   1        SwitchToGear(TargetMode); //»»µ½Ä¿±êµ²Î»
 336   1        }
 337            
 338          //²à°´µ¥»÷+³¤°´»»µ²»ØÍË²Ù×÷Ö´ÐÐ
 339          static void SideKey1HRevGearHandler(ModeIdxDef TargetMode)
 340            {
 341   1        if(!(ClickHoldReverseGearTIM&0x80))return;
 342   1        ClickHoldReverseGearTIM&=0x7F; //Çå³ý±ê¼ÇÎ»±ê¼Ç±¾´Î»»µ²Íê³É
 343   1        SwitchToGear(TargetMode); //»»µ½Ä¿±êµ²Î»
 344   1        } 
 345            
 346          //ÎÞ¼«µ÷¹â´¦Àí
 347          static void RampAdjHandler(void)
 348            {
 349   1        static bit IsKeyPressed=0;    
 350   1        //½øÐÐÁÁ¶Èµ÷Õû
 351   1        if(getSideKeyHoldEvent()&&!IsKeyPressed)RampCfg.Current+=3; //ÕýÏòÔö¼Ó»òÕß¼õÉÙµçÁ÷
 352   1        else if(getSideKeyClickAndHoldEvent()&&!IsKeyPressed)RampCfg.Current-=3; //Ôö¼Ó»òÕß¼õÉÙµçÁ÷ 
 353   1        else if(!getSideKeyClickAndHoldEvent()&&!getSideKeyHoldEvent()&&IsKeyPressed)IsKeyPressed=0; //ÓÃ»§·Å¿ª°
             -´¼ü£¬ÔÊÐíµ÷½Ú    
 354   1        //µçÁ÷´ïµ½ÉÏÏÞ
 355   1        if(getSideKeyHoldEvent()&&!IsKeyPressed&&RampCfg.Current>=CurrentMode->Current)
 356   1            {
 357   2            RampCfg.RampMaxDisplayTIM=4; //Ï¨Ãð0.5ÃëÖ¸Ê¾ÒÑ¾­µ½ÉÏÏÞ
 358   2            RampCfg.Current=CurrentMode->Current; //ÏÞÖÆµçÁ÷×î´óÖµ  
 359   2            IsKeyPressed=1;
 360   2            }   
C51 COMPILER V9.60.0.0   MODECONTROL                                                       11/09/2024 20:18:37 PAGE 7   

 361   1        //µçÁ÷´ïµ½ÏÂÏÞ
 362   1        if(getSideKeyClickAndHoldEvent()&&!IsKeyPressed&&RampCfg.Current<=CurrentMode->MinCurrent)
 363   1            {
 364   2            RampCfg.RampMaxDisplayTIM=4; //Ï¨Ãð0.5ÃëÖ¸Ê¾ÒÑ¾­µ½ÏÂÏÞ
 365   2            RampCfg.Current=CurrentMode->MinCurrent; //ÏÞÖÆµçÁ÷×îÐ¡Öµ
 366   2            IsKeyPressed=1;
 367   2            }     
 368   1        //½øÐÐÊý¾Ý±£´æµÄÅÐ¶Ï
 369   1        if(getSideKeyHoldEvent()||getSideKeyClickAndHoldEvent())RampCfg.CfgSavedTIM=0; //°´¼ü°´ÏÂËµÃ÷ÕýÔÚµ÷Õû£¬¸´
             -Î»¼ÆÊ±Æ÷
 370   1        else if(RampCfg.CfgSavedTIM==32)
 371   1            {
 372   2            RampCfg.CfgSavedTIM++;
 373   2            SaveRampConfig(0);  //Ò»¶ÎÊ±¼äÄÚÃ»²Ù×÷ËµÃ÷ÒÑ¾­µ÷½ÚÍê±Ï£¬±£´æÊý¾Ý
 374   2            }
 375   1        }
 376          //PI»·Â·µÄÎÂ¿ØÊý¾Ý´¦ÀíÉùÃ÷
 377          int ThermalILIMCalc(int Input);
 378            
 379          //µ²Î»×´Ì¬»ú
 380          void ModeSwitchFSM(void)
 381            {
 382   1        bit IsHoldEvent;
 383   1        int ClickCount;
 384   1        //Íâ²¿±äÁ¿ÉùÃ÷
 385   1        extern volatile bit StrobeFlag;
 386   1        extern bit IsDisableTurbo;
 387   1        extern bit IsForceLeaveTurbo;
 388   1        //»ñÈ¡°´¼ü×´Ì¬
 389   1        IsHoldEvent=getSideKeyLongPressEvent(); 
 390   1        ClickCount=getSideKeyShortPressCount(1);  //¶ÁÈ¡°´¼ü´¦Àíº¯Êý´«¹ýÀ´µÄ²ÎÊý
 391   1        //µ²Î»¼ÇÒä²ÎÊý¼ì²é
 392   1        if(LastMode==Mode_OFF||LastMode>=ModeTotalDepth)LastMode=Mode_Low;
 393   1        //×´Ì¬»ú
 394   1        if(ErrCode==Fault_DCDCFailedToStart||ErrCode==Fault_DCDCENOOC)return; //ÖÂÃü³õÊ¼»¯´íÎó
 395   1        else switch(CurrentMode->ModeIdx) 
 396   1          {
 397   2          //³öÏÖ´íÎó  
 398   2          case Mode_Fault:
 399   2            IsTacMode=0; //¹ÊÕÏºó×Ô¶¯È¡ÏûÕ½ÊõÄ£Ê½     
 400   2            if(!IsHoldEvent||ErrCode==Fault_OverHeat)break; //ÓÃ»§Ã»ÓÐ°´ÏÂ°´Å¥»òÕßÊÇ¹ýÈÈ×´Ì¬²»ÔÊÐíÖØÖÃ
 401   2            ErrCode=Fault_None; //ÎÞ¹ÊÕÏ
 402   2            SwitchToGear(Mode_OFF);  //³¤°´ÖØÖÃ´íÎó
 403   2            break;
 404   2          //¹Ø»ú×´Ì¬
 405   2          case Mode_OFF:
 406   2            if(ClickCount==5)
 407   2                {
 408   3                IsTacMode=0; //Ëø¶¨½âËøÊ±×Ô¶¯ÍË³öÕ½ÊõÄ£Ê½
 409   3                IsLocked=IsLocked?0:1; //Ëø¶¨×´Ì¬ÇÐ»»
 410   3                DisplayLockedTIM=8; //Ö¸Ê¾Ëø¶¨×´Ì¬ÇÐ»»
 411   3                }
 412   2            else if(IsLocked&&(ClickCount>0||IsKeyEventOccurred()))LEDMode=LED_RedBlinkFifth; //Ö¸Ê¾ÊÖµçÒÑ±»Ëø¶¨
 413   2            //·ÇËø¶¨×´Ì¬Õý³£´¦ÀíµÄÊÂÏî
 414   2            if(IsLocked)break;
 415   2            //Õ½ÊõÄ£Ê½
 416   2            if(ClickCount==6)  //6»÷½øÈë
 417   2                {
 418   3                IsTacMode=IsTacMode?0:1; //ÇÐ»»Õ½ÊõÄ£Ê½¿ª¹Ø
 419   3                DisplayLockedTIM=2; //Ö¸Ê¾Õ½ÊõÇÐ»»
 420   3                }
 421   2            if(IsTacMode) //Õ½ÊõÄ£Ê½¼¤»îÊ±½øÐÐÅÐ¶Ï
C51 COMPILER V9.60.0.0   MODECONTROL                                                       11/09/2024 20:18:37 PAGE 8   

 422   2                {
 423   3                if(!getSideKeyHoldEvent())break;
 424   3                if(Battery>3.1&&!IsDisableTurbo)SwitchToGear(Mode_Turbo); //µç³ØµçÁ¿³ä×ãÇÒÃ»ÓÐ¹ýÈÈËø¼«ÁÁ£¬Õý³£¿ªÆô
 425   3                else if(Battery>2.7)SwitchToGear(Mode_High);  //µç³Øµç³ØµçÁ¿²»×ãÊ±½øÈë¸ßÁÁ
 426   3                else LEDMode=LED_RedBlinkFifth; //µç³ØµçÁ¿ÑÏÖØ²»×ã£¬ºìÉ«ÉÁÎå´Î
 427   3                break;
 428   3                }
 429   2            //·ÇËø¶¨Õý³£µ¥»÷¿ª¹Ø»úµÄÊÂÏî
 430   2            if(ClickCount==1) //²à°´µ¥»÷¿ª»ú½øÈëÑ­»·
 431   2                {
 432   3                if(Battery>2.9)SwitchToGear(IsRampEnabled?Mode_Ramp:LastMode); //Õý³£¿ªÆô
 433   3                else if(Battery>2.7)SwitchToGear(Mode_Moon);   //´óÓÚ2.7VµÄÊ±ºòÖ»ÄÜ¿ªÔÂ¹â
 434   3                else LEDMode=LED_RedBlinkFifth; //µç³ØµçÁ¿ÑÏÖØ²»×ã£¬ºìÉ«ÉÁÎå´Î
 435   3                }     
 436   2            else if(ClickCount==2)  //Ë«»÷Ò»¼ü¼«ÁÁ    
 437   2                {
 438   3                if(IsDisableTurbo)break; //ÊÖµçÎÂ¶È¹ý¸ßËøËÀ¼«ÁÁ£¬²»×ö·´Ó¦
 439   3                else if(Battery>3.1)SwitchToGear(Mode_Turbo); //µç³ØµçÁ¿³ä×ãÕý³£¿ªÆô
 440   3                else SwitchToGear(IsRampEnabled?Mode_Ramp:LastMode);  //µç³Øµç³ØµçÁ¿²»×ãÊ±Ë«»÷½øÈëÆÕÍ¨Ä£Ê½
 441   3                }
 442   2            else if(IsHoldEvent)SwitchToGear(Mode_Moon); //³¤°´¿ª»úÖ±½Ó½øÔÂ¹â         
 443   2            else if(ClickCount==3)SwitchToGear(Mode_Strobe); //²à°´Èý»÷½øÈë±¬ÉÁ   
 444   2            else if(ClickCount==4) //ËÄ»÷ÇÐ»»µ²Î»Ä£Ê½ºÍÎÞ¼«µ÷¹â
 445   2                { 
 446   3                IsRampEnabled=IsRampEnabled?0:1; //×ª»»ÎÞ¼«µ÷¹â×´Ì¬ 
 447   3                LEDMode=!IsRampEnabled?LED_RedBlinkThird:LED_GreenBlinkThird; //ÏÔÊ¾ÊÇ·ñ¿ªÆô
 448   3                SaveRampConfig(0); //±£´æÅäÖÃµ½ROMÄÚ
 449   3                }
 450   2            else if(getSideKeyClickAndHoldEvent())TriggerVshowDisplay(); //µ¥»÷³¤°´²é¿´µç³Øµ±Ç°µçÑ¹ºÍµçÁ¿
 451   2            break;
 452   2          //ÔÂ¹â×´Ì¬
 453   2           case Mode_Moon:
 454   2             BatteryLowAlertProcess(true,Mode_Moon);
 455   2             if(ClickCount==1)//²à°´µ¥»÷¹Ø»ú
 456   2                {
 457   3                if(IsEnableMoonConfigMode)SaveRampConfig(0); //ÔÂ¹âÁÁ¶È·¢Éúµ÷Õû£¬±£´æÅäÖÃµ½ROMÄÚ
 458   3                IsEnableMoonConfigMode=0;
 459   3                ReturnToOFFState(); //»Øµ½¹Ø»ú×´Ì¬
 460   3                }
 461   2             if(IsEnableMoonConfigMode)break; //½øÈëÅäÖÃÄ£Ê½ºó×èÖ¹ÏìÓ¦
 462   2             //·ÇÅäÖÃÄ£Ê½ÏÂÔÊÐíµÄ²Ù×÷
 463   2             if(ClickCount==4)IsEnableMoonConfigMode=1; //ËÄ»÷½øÈëÅäÖÃÄ£Ê½
 464   2             if(IsHoldEvent&&Battery>2.9)  //µç³ØµçÑ¹³ä×ã£¬³¤°´½øÈëµÍÁÁµ²Î»
 465   2                {
 466   3                SwitchToGear(IsRampEnabled?Mode_Ramp:Mode_Low); //³¤°´»Øµ½Õý³£µ²Î»Ä£Ê½
 467   3                if(IsRampEnabled)RestoreToMinimumRampCurrent(); //Èç¹ûÊÇÎÞ¼«µ÷¹âÔò»Ö¸´µ½×îµÍµçÁ÷
 468   3                HoldChangeGearTIM|=0x40; //¶ÌÊ±¼äÄÚ½ûÖ¹³¤°´»»µ²£¬È·±£ÒªÓÃ»§ËÉ¿ªºó²ÅÄÜ»»
 469   3                RampCfg.RampMaxDisplayTIM=4; //Ï¨Ãð0.5Ãë½øÐÐÇÐ»»
 470   3                }       
 471   2              break;      
 472   2          //ÎÞ¼«µ÷¹â×´Ì¬        
 473   2          case Mode_Ramp:
 474   2              BatteryLowAlertProcess(true,Mode_Ramp);
 475   2              if(ClickCount==1||(IsTacMode&&!getSideKeyHoldEvent()))ReturnToOFFState();//²à°´µ¥»÷»òÕßÔÚÕ½ÊõÄ£Ê½ÏÂË
             -É¿ª°´Å¥Ê±¹Ø»ú
 476   2              if(ClickCount==2&&!IsDisableTurbo)SwitchToGear(Mode_Turbo); //Ë«»÷¼«ÁÁ
 477   2              if(ClickCount==3)SwitchToGear(Mode_Strobe); //²à°´3»÷½øÈë±¬ÉÁ
 478   2              //ÎÞ¼«µ÷¹â´¦Àí
 479   2              RampAdjHandler();     
 480   2              break;
 481   2          //µÍÁÁ×´Ì¬    
 482   2          case Mode_Low:
C51 COMPILER V9.60.0.0   MODECONTROL                                                       11/09/2024 20:18:37 PAGE 9   

 483   2              BatteryLowAlertProcess(true,Mode_Low);
 484   2              if(ClickCount==1||(IsTacMode&&!getSideKeyHoldEvent()))ReturnToOFFState();//²à°´µ¥»÷»òÕßÔÚÕ½ÊõÄ£Ê½ÏÂË
             -É¿ª°´Å¥Ê±¹Ø»ú
 485   2              if(ClickCount==2&&!IsDisableTurbo)SwitchToGear(Mode_Turbo); //Ë«»÷¼«ÁÁ
 486   2              if(ClickCount==3)SwitchToGear(Mode_Strobe); //²à°´3»÷½øÈë±¬ÉÁ
 487   2              //³¤°´»»µ²´¦Àí
 488   2              SideKeySwitchGearHandler(Mode_Mid); //»»µ½ÖÐµµ
 489   2              break;          
 490   2          //ÖÐÁÁ×´Ì¬    
 491   2          case Mode_Mid:
 492   2              BatteryLowAlertProcess(false,Mode_Low);
 493   2              if(ClickCount==1||(IsTacMode&&!getSideKeyHoldEvent()))ReturnToOFFState();//²à°´µ¥»÷»òÕßÔÚÕ½ÊõÄ£Ê½ÏÂË
             -É¿ª°´Å¥Ê±¹Ø»ú
 494   2              if(ClickCount==2&&!IsDisableTurbo)SwitchToGear(Mode_Turbo); //Ë«»÷¼«ÁÁ
 495   2              if(ClickCount==3)SwitchToGear(Mode_Strobe); //²à°´3»÷½øÈë±¬ÉÁ
 496   2              //³¤°´»»µ²´¦Àí
 497   2              SideKeySwitchGearHandler(Mode_MHigh); //»»µ½ÖÐ¸ßµµ
 498   2              SideKey1HRevGearHandler(Mode_Low); //µ¥»÷+³¤°´»ØÍËµ²Î»µ½µÍµµ
 499   2              break;  
 500   2          //ÖÐ¸ßÁÁ×´Ì¬
 501   2          case Mode_MHigh:
 502   2              BatteryLowAlertProcess(false,Mode_Mid);
 503   2              if(ClickCount==1||(IsTacMode&&!getSideKeyHoldEvent()))ReturnToOFFState();//²à°´µ¥»÷»òÕßÔÚÕ½ÊõÄ£Ê½ÏÂË
             -É¿ª°´Å¥Ê±¹Ø»ú
 504   2              if(ClickCount==2&&!IsDisableTurbo)SwitchToGear(Mode_Turbo); //Ë«»÷¼«ÁÁ
 505   2              if(ClickCount==3)SwitchToGear(Mode_Strobe); //²à°´3»÷½øÈë±¬ÉÁ
 506   2              //³¤°´»»µ²´¦Àí
 507   2              SideKeySwitchGearHandler(Mode_High); //»»µ½¸ßµµ
 508   2              SideKey1HRevGearHandler(Mode_Mid); //µ¥»÷+³¤°´»ØÍËµ²Î»µ½ÖÐµµ
 509   2              break;  
 510   2          //¸ßÁÁ×´Ì¬
 511   2          case Mode_High:
 512   2              BatteryLowAlertProcess(false,Mode_MHigh);
 513   2              if(ClickCount==1||(IsTacMode&&!getSideKeyHoldEvent()))ReturnToOFFState();//²à°´µ¥»÷»òÕßÔÚÕ½ÊõÄ£Ê½ÏÂË
             -É¿ª°´Å¥Ê±¹Ø»ú
 514   2              if(ClickCount==2&&!IsDisableTurbo)SwitchToGear(Mode_Turbo); //Ë«»÷¼«ÁÁ
 515   2              if(ClickCount==3)SwitchToGear(Mode_Strobe); //²à°´3»÷½øÈë±¬ÉÁ
 516   2              //³¤°´»»µ²´¦Àí
 517   2              SideKeySwitchGearHandler(Mode_Low); //»»µ½µÍµµÎ»¹¹³ÉÑ­»·
 518   2              SideKey1HRevGearHandler(Mode_MHigh); //µ¥»÷+³¤°´»ØÍËµ²Î»µ½ÖÐ¸ßµµ
 519   2              break;
 520   2          //¼«ÁÁ×´Ì¬
 521   2          case Mode_Turbo:
 522   2              BatteryLowAlertProcess(false,Mode_High);
 523   2              if(ClickCount==1||(IsTacMode&&!getSideKeyHoldEvent()))ReturnToOFFState();//²à°´µ¥»÷»òÕßÔÚÕ½ÊõÄ£Ê½ÏÂË
             -É¿ª°´Å¥Ê±¹Ø»ú
 524   2              if(ClickCount==2||IsForceLeaveTurbo)SwitchToGear(IsRampEnabled?Mode_Ramp:Mode_Low); //Ë«»÷»òÕßÎÂ¶È´ïµ
             -½ÉÏÏÞÖµ£¬Ç¿ÖÆ·µ»Øµ½µÍÁÁ
 525   2              if(ClickCount==3)SwitchToGear(Mode_Strobe); //²à°´3»÷½øÈë±¬ÉÁ
 526   2              break;  
 527   2          //±¬ÉÁ×´Ì¬
 528   2          case Mode_Strobe:
 529   2              BatteryLowAlertProcess(true,Mode_Strobe);
 530   2              if(ClickCount==1||(IsTacMode&&!getSideKeyHoldEvent()))ReturnToOFFState();//²à°´µ¥»÷»òÕßÔÚÕ½ÊõÄ£Ê½ÏÂË
             -É¿ª°´Å¥Ê±¹Ø»ú
 531   2              if(ClickCount==2&&!IsDisableTurbo)SwitchToGear(Mode_Turbo); //Ë«»÷¼«ÁÁ
 532   2              if(ClickCount==3)SwitchToGear(IsRampEnabled?Mode_Ramp:Mode_Low); //Èý»÷ÍË»Øµ½ÆÕÍ¨Ä£Ê½
 533   2              //³¤°´»»µ²´¦Àí
 534   2              SideKeySwitchGearHandler(Mode_SOS); //³¤°´ÇÐ»»µ½SOS
 535   2              break;  
 536   2          //SOSÇó¾Èµ²Î»   
 537   2          case Mode_SOS:
C51 COMPILER V9.60.0.0   MODECONTROL                                                       11/09/2024 20:18:37 PAGE 10  

 538   2              BatteryLowAlertProcess(true,Mode_SOS);
 539   2              if(ClickCount==1||(IsTacMode&&!getSideKeyHoldEvent()))ReturnToOFFState();//²à°´µ¥»÷»òÕßÔÚÕ½ÊõÄ£Ê½ÏÂË
             -É¿ª°´Å¥Ê±¹Ø»ú
 540   2              if(ClickCount==2&&!IsDisableTurbo)SwitchToGear(Mode_Turbo); //Ë«»÷¼«ÁÁ
 541   2              if(ClickCount==3)SwitchToGear(IsRampEnabled?Mode_Ramp:Mode_Low); //Èý»÷ÍË»Øµ½ÆÕÍ¨Ä£Ê½
 542   2              //³¤°´»»µ²´¦Àí
 543   2              SideKeySwitchGearHandler(Mode_Strobe); //³¤°´ÇÐ»»µ½±¬ÉÁ
 544   2              break;  
 545   2          }
 546   1        //Ó¦ÓÃÊä³öµçÁ÷
 547   1        if(DisplayLockedTIM>0)TargetCurrent=80; //ÓÃ»§½øÈë»òÕßÍË³öËø¶¨£¬ÓÃ80mA¶ÌÔÝµãÁÁÌáÊ¾Ò»ÏÂ
 548   1        else if(!StrobeFlag&&CurrentMode->ModeIdx==Mode_Strobe)TargetCurrent=-1;   //±¬ÉÁÄ£Ê½ÏÂÈÃµçÁ÷¸úËæflag(-1µç
             -Á÷±íÊ¾²»¹Ø±Õ·À·´½ÓFET)
 549   1        else if(RampCfg.RampMaxDisplayTIM>0)TargetCurrent=-1; //ÎÞ¼«µ÷¹âÄ£Ê½ÔÚµÖ´ïÉÏÏÂÏÞºó¶ÌÔÝÏ¨Ãð(-1µçÁ÷±íÊ¾²»¹Ø
             -±Õ·À·´½ÓFET)
 550   1        else if(CurrentMode->ModeIdx==Mode_Ramp)TargetCurrent=RampCfg.Current; //ÎÞ¼«µ÷¹âÄ£Ê½È¡ÎÞ¼«µ÷¹â²ÎÊý½á¹¹Ì
             -åÄÚµÄµçÁ÷
 551   1        else if(CurrentMode->ModeIdx==Mode_SOS)TargetCurrent=SOSFSM(); //SOSÄ£Ê½£¬Êä³öµçÁ÷ÊÜSOS×´Ì¬»úµ÷¿Ø
 552   1        else if(CurrentMode->ModeIdx==Mode_Moon)switch(MoonCfg)
 553   1          {
 554   2          case MoonLight_10mA:TargetCurrent=10;break;  //10mA
 555   2          case MoonLight_25mA:TargetCurrent=25;break;  //25mA
 556   2          case MoonLight_50mA:TargetCurrent=50;break;  //50mA
 557   2          case MoonLight_100mA:TargetCurrent=100;break; //100mA
 558   2          case MoonLight_200mA:TargetCurrent=200;break; //200mA
 559   2          case MoonLight_UsingModeDef:TargetCurrent=CurrentMode->Current;break; //Ê¹ÓÃÄ£Ê½½á¹¹ÌåÄÚµÄ½á¹û
 560   2          }
 561   1        else TargetCurrent=CurrentMode->Current;    
 562   1        //¸ù¾ÝÎÂ¿ØµÄÔËËã½á¹û¶ÔÊä³öµçÁ÷½øÐÐÏÞ·ù
 563   1        Current=ThermalILIMCalc(TargetCurrent); 
 564   1        }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2259    ----
   CONSTANT SIZE    =     99    ----
   XDATA SIZE       =     14    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7      12
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      5       1
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
