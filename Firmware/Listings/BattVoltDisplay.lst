C51 COMPILER V9.60.0.0   BATTVOLTDISPLAY                                                   11/10/2024 11:12:35 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE BATTVOLTDISPLAY
OBJECT MODULE PLACED IN .\Objects\BattVoltDisplay.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Logic\BattVoltDisplay.c OMF2 OPTIMIZE(9,SPEED) BROWSE INCDIR(.\include;.
                    -\StdDriver\inc;.\Hardware) DEBUG PRINT(.\Listings\BattVoltDisplay.lst) TABS(2) OBJECT(.\Objects\BattVoltDisplay.obj)

line level    source

   1          #include "ADCCfg.h"
   2          #include "LEDMgmt.h"
   3          #include "delay.h"
   4          #include "ModeControl.h"
   5          #include "SideKey.h"
   6          #include "cms8s6990.h"
   7          #include "BattDisplay.h"
   8          
   9          //Æ½¾ù¼ÆËã½á¹¹Ìå
  10          typedef struct
  11            {
  12            int Min;
  13            int Max;
  14            long AvgBuf;
  15            int Count;
  16            }AverageCalcDef;  
  17            
  18          //º¯ÊıÉùÃ÷
  19          void DisplayErrorIDHandler(void);
  20            
  21            
  22          //ÄÚ²¿È«¾Ö±äÁ¿
  23          static xdata char BattShowTimer=0; //µç³ØµçÁ¿ÏÔÊ¾ÃüÁî
  24          static xdata BattStatusDef BattState; //µç³ØµçÁ¿±ê¼ÇÎ»
  25          static xdata AverageCalcDef BattVolt; 
  26          xdata float Battery; //µç³ØµçÑ¹
  27          bit IsBatteryAlert; //µç³ØµçÑ¹µÍÓÚ¾¯¸æÖµ  
  28          bit IsBatteryFault; //µç³ØµçÑ¹µÍÓÚ±£»¤Öµ    
  29          static xdata int VshowTIM=0;
  30          static xdata float VbattSample; //È¡ÑùµÄµç³ØµçÑ¹
  31          xdata BattVshowFSMDef VshowFSMState; //µç³ØµçÑ¹ÏÔÊ¾ËùĞèµÄ¼ÆÊ±Æ÷ºÍ×´Ì¬»ú×ªÒÆ
  32          
  33          //Æô¶¯µç³ØµçÑ¹ÏÔÊ¾
  34          void TriggerVshowDisplay(void)  
  35            {
  36   1        if(VshowFSMState!=BattVdis_Waiting)return; //·ÇµÈ´ıÏÔÊ¾×´Ì¬½ûÖ¹²Ù×÷
  37   1        VshowFSMState=BattVdis_PrepareDis;
  38   1        }   
  39            
  40          //µç³ØÏêÏ¸µçÑ¹ÏÔÊ¾´¦Àí
  41          static void BatVshowFSM(void)
  42            {
  43   1        int buf;
  44   1        //µçÁ¿ÏÔÊ¾×´Ì¬»ú
  45   1        switch(VshowFSMState)
  46   1          {
  47   2          case BattVdis_Waiting:break; //µÈ´ıÏÔÊ¾½×¶Î
  48   2          case BattVdis_PrepareDis: //×¼±¸ÏÔÊ¾
  49   2            LEDMode=LED_OFF; //¹Ø±ÕLED
  50   2            VbattSample=Data.RawBattVolt; //½øĞĞµçÑ¹È¡Ñù
  51   2            VshowTIM=14; //ÑÓ³Ù1.75Ãë
  52   2            VshowFSMState=BattVdis_DelayBeforeDisplay; //½øĞĞ¼òµ¥µÄÑÓ³Ù
  53   2          //ÑÓ³Ù²¢ÏÔÊ¾¿ªÍ·
  54   2          case BattVdis_DelayBeforeDisplay:
C51 COMPILER V9.60.0.0   BATTVOLTDISPLAY                                                   11/10/2024 11:12:35 PAGE 2   

  55   2            if(VshowTIM>12)LEDMode=LED_Green;
  56   2            else if(VshowTIM>10)LEDMode=LED_Amber;    
  57   2            else if(VshowTIM>8)LEDMode=LED_Red; 
  58   2            else LEDMode=LED_OFF; //ºìÂÌÀ¶ÉÁË¸Ö®ºóµÈ´ı
  59   2            //Í·²¿ÏÔÊ¾½áÊøºó¿ªÊ¼ÕıÊ½ÏÔÊ¾µçÑ¹
  60   2            if(VshowTIM>0)break; //Ê±¼äÎ´µ½
  61   2            buf=(int)VbattSample%100; //È¥³ıµô99ÒÔÉÏµÄ
  62   2            buf/=10; //ÏÔÊ¾Ê®Î»
  63   2            if(buf==0)VshowTIM=-1; //0=Ë²¼äÉÁÒ»ÏÂ
  64   2            else VshowTIM=(4*buf)-1; //ÅäÖÃÏÔÊ¾µÄÊ±³¤
  65   2            VshowFSMState=BattVdis_Show10V; //Ìø×ªµ½10VÏÔÊ¾
  66   2            break;
  67   2          //ÏÔÊ¾Ê®Î»
  68   2          case BattVdis_Show10V:
  69   2            if(VshowTIM==-1)//Í¨¹ı¿ìÉÁÒ»´Î±íÊ¾ÊÇ0
  70   2              {
  71   3              MakeFastStrobe(LED_Red);
  72   3              VshowTIM=0; 
  73   3              }
  74   2            buf=VshowTIM%4;
  75   2            LEDMode=buf>1?LED_Red:LED_OFF; //ÖÆÔìºìÉ«ÉÁË¸Ö¸Ê¾10V×´Ì¬
  76   2            if(VshowTIM<=0) //ÏÔÊ¾½áÊø
  77   2              {
  78   3              LEDMode=LED_OFF;
  79   3              VshowTIM=10;
  80   3              VshowFSMState=BattVdis_Gap10to1V; //µÈ´ıÒ»»á
  81   3              }
  82   2            break;
  83   2          //Ê®Î»ºÍ¸öÎ»Ö®¼äµÄ¼ä¸ô
  84   2          case BattVdis_Gap10to1V:
  85   2            if(VshowTIM>0)break; //Ê±¼äÎ´µ½
  86   2            buf=(int)VbattSample; 
  87   2            buf%=10; //ÏÔÊ¾¸öÎ»
  88   2            if(buf==0)VshowTIM=-1; //0=Ë²¼äÉÁÒ»ÏÂ
  89   2            else VshowTIM=(4*buf)-1; //ÅäÖÃÏÔÊ¾µÄÊ±³¤
  90   2            VshowFSMState=BattVdis_Show1V; //Ìø×ªµ½1VÏÔÊ¾ 
  91   2            break;  
  92   2          //ÏÔÊ¾¸öÎ»
  93   2          case BattVdis_Show1V:
  94   2            if(VshowTIM==-1)//Í¨¹ı¿ìÉÁÒ»´Î±íÊ¾ÊÇ0
  95   2              {
  96   3              MakeFastStrobe(LED_Amber);
  97   3              VshowTIM=0; 
  98   3              }
  99   2            buf=VshowTIM%4;
 100   2            LEDMode=buf>1?LED_Amber:LED_OFF; //ÖÆÔìºìÉ«ÉÁË¸Ö¸Ê¾1V×´Ì¬
 101   2            if(VshowTIM<=0) //ÏÔÊ¾½áÊø
 102   2              {
 103   3              LEDMode=LED_OFF;
 104   3              VshowTIM=10;
 105   3              VshowFSMState=BattVdis_Gap1to0_1V; //µÈ´ıÒ»»á
 106   3              }
 107   2            break;
 108   2          //¸öÎ»ºÍÊ®·ÖÎ»Ö®¼äµÄ¼ä¸ô    
 109   2          case BattVdis_Gap1to0_1V: 
 110   2              if(VshowTIM>0)break; //Ê±¼äÎ´µ½
 111   2              VbattSample*=(float)10;
 112   2              buf=(int)VbattSample; //³Ë10½«Ğ¡ÊıµãºóÒ»Î»Ëõ·ÅÎª¸öÎ» 
 113   2              buf%=10; //µÃµ½Ê®·ÖÎ»×´Ì¬
 114   2              if(buf==0)VshowTIM=-1; //0=Ë²¼äÉÁÒ»ÏÂ
 115   2              else VshowTIM=(4*buf)-1; //ÅäÖÃÏÔÊ¾µÄÊ±³¤
 116   2              VshowFSMState=BattVdis_Show0_1V; //Ìø×ªµ½0.1VÏÔÊ¾
C51 COMPILER V9.60.0.0   BATTVOLTDISPLAY                                                   11/10/2024 11:12:35 PAGE 3   

 117   2              break;
 118   2          //ÏÔÊ¾Ğ¡ÊıµãºóÒ»Î»(0.1V)
 119   2          case BattVdis_Show0_1V:
 120   2            if(VshowTIM==-1)//Í¨¹ı¿ìÉÁÒ»´Î±íÊ¾ÊÇ0
 121   2              {
 122   3              MakeFastStrobe(LED_Green);
 123   3              VshowTIM=0; 
 124   3              }
 125   2            buf=VshowTIM%4;
 126   2            LEDMode=buf>1?LED_Green:LED_OFF; //ÖÆÔìÂÌÉ«ÉÁË¸Ö¸Ê¾0.1V×´Ì¬
 127   2            if(VshowTIM<=0) //ÏÔÊ¾½áÊø
 128   2              {
 129   3              LEDMode=LED_OFF;
 130   3              VshowTIM=12; 
 131   3              VshowFSMState=BattVdis_WaitShowChargeLvl; //µÈ´ı1Ãëºó¿ªÊ¼ÏÔÊ¾µçÁ¿
 132   3              }
 133   2            break;
 134   2          //µÈ´ıÒ»¶ÎÊ±¼äºóÏÔÊ¾µ±Ç°µçÁ¿
 135   2          case BattVdis_WaitShowChargeLvl:
 136   2            if(VshowTIM>0)break;
 137   2            BattShowTimer=0x80; //Æô¶¯×ÜÌåµçÁ¿ÏÔÊ¾
 138   2            VshowFSMState=BattVdis_ShowChargeLvl; //µÈ´ıµçÁ¿ÏÔÊ¾×´Ì¬½áÊø
 139   2            break;
 140   2          //µÈ´ı×ÜÌåµçÁ¿ÏÔÊ¾½áÊø
 141   2          case BattVdis_ShowChargeLvl:
 142   2            if(BattShowTimer&0x80||getSideKeyClickAndHoldEvent())break; //ÓÃ»§ÈÔÈ»°´ÏÂ°´¼ü£¬µÈ´ıÓÃ»§ËÉ¿ª
 143   2            VshowFSMState=BattVdis_Waiting; //ÏÔÊ¾½áÊø£¬ÍË»Øµ½µÈ´ı½×¶Î
 144   2            break;
 145   2          }
 146   1        }
 147          
 148          //ÔÚÆô¶¯Ê±ÏÔÊ¾µç³ØµçÑ¹
 149          void DisplayVBattAtStart(void)
 150            {
 151   1        //ÌáÇ°¸üĞÂµç³ØµçÁ¿×´Ì¬
 152   1        if(Data.BatteryVoltage<2.9)BattState=Battery_VeryLow; //µç³ØµçÑ¹µÍÓÚ2.8£¬Ö±½Ó±¨¸æÑÏÖØ²»×ã
 153   1        else if(Data.BatteryVoltage<3.2)BattState=Battery_Low; //µç³ØµçÑ¹µÍÓÚ3.2ÔòÇĞ»»µ½µçÁ¿µÍµÄ×´Ì¬
 154   1        else if(Data.BatteryVoltage<3.6)BattState=Battery_Mid; //µç³ØµçÁ¿µÍÓÚ3.5Ôò±íÊ¾ÎªÖĞµÈ
 155   1        else BattState=Battery_Plenty; //µçÁ¿³ä×ã
 156   1        //Çå³ıµç³Ø¹ÊÕÏºÍ¾¯¸æÎ»  
 157   1        IsBatteryAlert=0;
 158   1        IsBatteryFault=0;
 159   1        //³õÊ¼»¯Æ½¾ùÖµ»º´æ
 160   1        BattVolt.Min=32766;
 161   1        BattVolt.Max=-32766; //¸´Î»×î´ó×îĞ¡²¶»ñÆ÷
 162   1        BattVolt.Count=0;
 163   1        BattVolt.AvgBuf=0; //Çå³ıÆ½¾ù¼ÆÊıÆ÷ºÍ»º´æ
 164   1        Battery=Data.BatteryVoltage; //¸üĞÂµç³ØµçÑ¹
 165   1        //¸´Î»µç³ØµçÑ¹ÏÔÊ¾×´Ì¬»ú    
 166   1        VbattSample=Data.RawBattVolt; 
 167   1        VshowFSMState=BattVdis_Waiting; //ÏÔÊ¾×´Ì¬ÉèÖÃÎªµÈ´ı
 168   1        //Æô¶¯µç³ØµçÁ¿ÏÔÊ¾(½öÎŞ´íÎóµÄÇé¿öÏÂ)
 169   1        if(ErrCode==Fault_None)BattShowTimer=0x80;
 170   1        }
 171          //µç³ØµçÁ¿ÏÔÊ¾ÑÓÊ±µÄ´¦Àí
 172          void BattDisplayTIM(void)
 173            {
 174   1        char buf;
 175   1        //µç³ØµçÑ¹ÏÔÊ¾µÄ¼ÆÊ±Æ÷´¦Àí  
 176   1        if(VshowTIM>0)VshowTIM--;
 177   1        //µç³ØÏÔÊ¾¶¨Ê±Æ÷
 178   1        if(BattShowTimer&0x80)  
C51 COMPILER V9.60.0.0   BATTVOLTDISPLAY                                                   11/10/2024 11:12:35 PAGE 4   

 179   1          {
 180   2          buf=BattShowTimer&0x7F; //È¡³öTIMÖµ
 181   2          BattShowTimer&=0x80; //È¥³ıµôÔ­Ê¼µÄTIMÖµ
 182   2          if(buf<12)
 183   2            {
 184   3            buf++;
 185   3            BattShowTimer|=buf; //°ÑÊıÖµĞ´»ØÈ¥
 186   3            }
 187   2          else BattShowTimer=0; //¶¨Ê±Æ÷µ½Ê±¼äÁË×Ô¶¯Í£Ö¹
 188   2          }
 189   1        else BattShowTimer=0; //Çå³ıbuf   
 190   1        } 
 191            
 192          //µç³Ø²ÎÊı²âÁ¿ºÍÖ¸Ê¾µÆ¿ØÖÆ
 193          void BatteryTelemHandler(void)
 194            {
 195   1        float AlertThr;
 196   1        long buf;
 197   1        //µçÁ¿Æ½¾ùÄ£¿é¼ÆËã
 198   1        if(BattVolt.Count<VBattAvgCount)    
 199   1          {
 200   2          buf=(long)(Data.BatteryVoltage*1000);
 201   2          BattVolt.Count++;
 202   2          BattVolt.AvgBuf+=buf;
 203   2          if(BattVolt.Min>buf)BattVolt.Min=buf;
 204   2          if(BattVolt.Max<buf)BattVolt.Max=buf; //¼«Öµ¶ÁÈ¡
 205   2          }
 206   1        else //Æ½¾ù´ÎÊıµ½£¬¸üĞÂµçÑ¹
 207   1          {
 208   2          BattVolt.AvgBuf-=(long)BattVolt.Min+(long)BattVolt.Max; //È¥µô×î¸ß×îµÍ
 209   2          BattVolt.AvgBuf/=(long)(BattVolt.Count-2); //ÇóÆ½¾ùÖµ
 210   2          Battery=(float)BattVolt.AvgBuf/(float)1000; //µÃµ½×îÖÕµÄµç³ØµçÑ¹
 211   2          BattVolt.Min=32766;
 212   2          BattVolt.Max=-32766; //¸´Î»×î´ó×îĞ¡²¶»ñÆ÷
 213   2          BattVolt.Count=0;
 214   2          BattVolt.AvgBuf=0; //Çå³ıÆ½¾ù¼ÆÊıÆ÷ºÍ»º´æ   
 215   2          }
 216   1        //¸ù¾İµç³ØµçÑ¹¿ØÖÆflagÊµÏÖµÍµçÑ¹½µµµºÍ¹Ø»ú±£»¤
 217   1        if(CurrentMode->LowVoltThres==0) //µ±Ç°µ²Î»µç³ØµçÑ¹¾¯±¨¹Ø±Õ
 218   1           {
 219   2           IsBatteryAlert=0;
 220   2           IsBatteryFault=0; 
 221   2           }
 222   1        else //Õı³£½øĞĞ¾¯±¨
 223   1           {
 224   2           AlertThr=(float)(CurrentMode->LowVoltThres)/(float)1000; //´Óµ±Ç°Ä¿±êµ²Î»¶ÁÈ¡Ä£Ê½Öµ  
 225   2           IsBatteryAlert=Battery>AlertThr?0:1; //¾¯±¨bit
 226   2           IsBatteryFault=Battery>2.7?0:1; //¹ÊÕÏbit
 227   2           if(IsBatteryFault)IsBatteryAlert=0; //¹ÊÕÏbitÖÃÆğºóÇ¿ÖÆÇå³ı¾¯±¨bit
 228   2           }
 229   1        //µç³ØµçÁ¿Ö¸Ê¾×´Ì¬»ú
 230   1        switch(BattState) 
 231   1           {
 232   2           //µç³ØµçÁ¿³ä×ã
 233   2           case Battery_Plenty: 
 234   2              if(Battery<3.6)BattState=Battery_Mid; //µç³ØµçÑ¹Ğ¡ÓÚ3.7£¬»Øµ½µçÁ¿½ÏµÍ×´Ì¬
 235   2              break;
 236   2           //µç³ØµçÁ¿½ÏÎª³ä×ã
 237   2           case Battery_Mid:
 238   2              if(Battery>3.8)BattState=Battery_Plenty; //µç³ØµçÑ¹´óÓÚ3.8£¬»Øµ½³ä×ã×´Ì¬
 239   2              if(Battery<3.2)BattState=Battery_Low; //µç³ØµçÑ¹µÍÓÚ3.2ÔòÇĞ»»µ½µçÁ¿µÍµÄ×´Ì¬
 240   2              if(Battery<2.8)BattState=Battery_VeryLow; //µç³ØµçÑ¹µÍÓÚ2.8£¬Ö±½Ó±¨¸æÑÏÖØ²»×ã
C51 COMPILER V9.60.0.0   BATTVOLTDISPLAY                                                   11/10/2024 11:12:35 PAGE 5   

 241   2              break;
 242   2           //µç³ØµçÁ¿²»×ã
 243   2           case Battery_Low:
 244   2              if(Battery>3.85)BattState=Battery_Plenty; //µç³ØµçÑ¹´óÓÚ3.8£¬»Øµ½³ä×ã×´Ì¬
 245   2              if(Battery>3.5)BattState=Battery_Plenty; //µç³ØµçÑ¹¸ßÓÚ3.5£¬ÇĞ»»µ½µçÁ¿³ä×ãµÄ×´Ì¬
 246   2              if(Battery<2.9)BattState=Battery_VeryLow; //µç³ØµçÑ¹µÍÓÚ2.8£¬±¨¸æÑÏÖØ²»×ã
 247   2              break;
 248   2           //µç³ØµçÁ¿ÑÏÖØ²»×ã
 249   2           case Battery_VeryLow:
 250   2              if(Battery>3.85)BattState=Battery_Plenty; //µç³ØµçÑ¹´óÓÚ3.8£¬»Øµ½³ä×ã×´Ì¬
 251   2              if(Battery>3.5)BattState=Battery_Plenty; //µç³ØµçÑ¹´óÓÚ3.5£¬Ö±½ÓÌøµ½³ä×ã
 252   2              if(Battery>3.0)BattState=Battery_Low; //µç³ØµçÑ¹»ØÉıµ½3.0£¬Ìø×ªµ½µçÁ¿²»×ã½×¶Î
 253   2              break;
 254   2           }
 255   1        //LED¿ØÖÆ
 256   1        if(LEDMode==LED_RedBlinkFifth||LEDMode==LED_GreenBlinkThird||LEDMode==LED_RedBlinkThird)return; //ÆµÉÁÖ¸Ê
             -¾ÏÂ²»Ö´ĞĞ¿ØÖÆ 
 257   1        if(ErrCode!=Fault_None)DisplayErrorIDHandler(); //ÓĞ¹ÊÕÏ·¢Éú£¬ÏÔÊ¾´íÎó
 258   1        else if(CurrentMode->ModeIdx!=Mode_OFF||BattShowTimer&0x80)switch(BattState) //ÓÃ»§³¤°´°´¼ü²éÑ¯µçÁ¿»òÕßÊÖ
             -µç¿ª»ú£¬Ö¸Ê¾µçÁ¿
 259   1           {
 260   2           case Battery_Plenty:LEDMode=LED_Green;break; //µç³ØµçÁ¿³ä×ãÂÌÉ«³£ÁÁ
 261   2           case Battery_Mid:LEDMode=LED_Amber;break; //µç³ØµçÁ¿ÖĞµÈ»ÆÉ«³£ÁÁ
 262   2           case Battery_Low:LEDMode=LED_Red;break;//µç³ØµçÁ¿²»×ã
 263   2           case Battery_VeryLow:LEDMode=LED_RedBlink;break; //µç³ØµçÁ¿ÑÏÖØ²»×ãºìÉ«ÂıÉÁ
 264   2           }
 265   1        else if(VshowFSMState!=BattVdis_Waiting)BatVshowFSM();//µç³ØµçÑ¹ÏÔÊ¾Æô¶¯£¬Ö´ĞĞ×´Ì¬»ú  
 266   1        else LEDMode=LED_OFF; //ÊÖµç´¦ÓÚ¹Ø±Õ×´Ì¬£¬ÇÒÃ»ÓĞ°´¼ü°´ÏÂµÄ¶¯¾²£¬¹ÊLEDÉèÖÃÎª¹Ø±Õ
 267   1        }
 268            


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1545    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     23    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
