C51 COMPILER V9.60.0.0   OUTPUTCHANNEL                                                     11/15/2024 17:30:59 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE OUTPUTCHANNEL
OBJECT MODULE PLACED IN .\Objects\OutputChannel.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Hardware\OutputChannel.c OPTIMIZE(9,SPEED) BROWSE INCDIR(.\include;.\Std
                    -Driver\inc;.\Hardware) DEBUG OBJECTEXTEND PRINT(.\Listings\OutputChannel.lst) TABS(2) OBJECT(.\Objects\OutputChannel.obj
                    -)

line level    source

   1          #include "cms8s6990.h"
   2          #include "PinDefs.h"
   3          #include "GPIO.h"
   4          #include "PWMCfg.h"
   5          #include "delay.h"
   6          #include "ModeControl.h"
   7          #include "OutputChannel.h"
   8          #include "ADCCfg.h"
   9          #include "Watchdog.h"
  10          
  11          //ÄÚ²¿SFR
  12          sbit RevPGate=RevProtIOP^RevProtIOx; //·´½Ó±£»¤MOSFET
  13          sbit DCDCEN=DCDCENIOP^DCDCENIOx; //DCDCÊ¹ÄÜ¹¦ÄÜ
  14          sbit LShuntSEL=LShuntSelIOP^LShuntSelIOx; //µÍÁÁÔÂ¹âµµ×¨ÓÃ·ÖÁ÷Æ÷Ñ¡ÔñÎ»
  15          sbit HShuntSEL=HShuntSelIOP^HShuntSelIOx; //Ö÷Êä³ö·ÖÁ÷Æ÷Ñ¡ÔñÎ»
  16          
  17          //ÄÚ²¿±äÁ¿
  18          xdata int Current; //Ä¿±êµçÁ÷(mA)
  19          static xdata int CurrentBuf;
  20          static xdata char IsEnableDCDCCounter=0; //ÑÓÊ±ÆôÓÃDCDCµÄ¼ÆÊ±Æ÷
  21          
  22          //³õÊ¼»¯º¯Êý
  23          void OutputChannel_Init(void)
  24            {
  25   1        GPIOCfgDef OCInitCfg;
  26   1        //ÉèÖÃ½á¹¹Ìå
  27   1        OCInitCfg.Mode=GPIO_Out_PP;
  28   1        OCInitCfg.Slew=GPIO_Fast_Slew;    
  29   1        OCInitCfg.DRVCurrent=GPIO_High_Current; //ÍÆMOSFET,ÐèÒª¸ßÉÏÉýÐ±ÂÊ
  30   1        //³õÊ¼»¯bit
  31   1        RevPGate=0;
  32   1        DCDCEN=0;
  33   1        LShuntSEL=0;
  34   1        HShuntSEL=0;
  35   1        //¿ªÊ¼ÅäÖÃIO  
  36   1        GPIO_ConfigGPIOMode(RevProtIOG,GPIOMask(RevProtIOx),&OCInitCfg);  
  37   1        GPIO_ConfigGPIOMode(DCDCENIOG,GPIOMask(DCDCENIOx),&OCInitCfg);    
  38   1        GPIO_ConfigGPIOMode(LShuntSelIOG,GPIOMask(LShuntSelIOx),&OCInitCfg);    
  39   1        GPIO_ConfigGPIOMode(HShuntSelIOG,GPIOMask(HShuntSelIOx),&OCInitCfg);      
  40   1        //ÏµÍ³ÉÏµçÊ±µçÁ÷ÅäÖÃÎª0
  41   1        Current=0;
  42   1        CurrentBuf=0;
  43   1        }
  44          
  45          //Êä³öÍ¨µÀ²âÊÔÔËÐÐ
  46          void OutputChannel_TestRun(void)
  47            {
  48   1        int retry=64,i;
  49   1        xdata float LastOutput[5]={0};
  50   1        xdata float buf,Err;
  51   1        //¼ì²éÊÇ·ñÓÉ¿´ÃÅ¹·µ¼ÖÂ¸´Î»  
  52   1        if(GetIfWDogCauseRST()) 
  53   1          {
C51 COMPILER V9.60.0.0   OUTPUTCHANNEL                                                     11/15/2024 17:30:59 PAGE 2   

  54   2          ErrCode=Fault_MPUHang; //Ö¸Ê¾¹ÊÕÏÓÉµ¥Æ¬»úËÀ»úµ¼ÖÂ
  55   2          if(CurrentMode->ModeIdx!=Mode_Fault)SwitchToGear(Mode_Fault);  //Ö¸Ê¾¹ÊÕÏ·¢Éú
  56   2          return;
  57   2          }
  58   1        //×¼±¸Æô¶¯Êä³ö
  59   1        if(Data.RawBattVolt<5.5)return; //ÊäÈëµçÑ¹¹ýµÍ±ÜÃâÎó±¨£¬Ìø¹ý¼ì²â
  60   1        LShuntSEL=0;
  61   1        HShuntSEL=0;
  62   1        RevPGate=0; //¹Ø±Õ·À·´½Ó¼ì²âPIN
  63   1        PWM_ForceSetDuty(1); //´ò¿ªPWMDACÊä³öÒ»¸ö³õÖµ   
  64   1        DCDCEN=1; //ÁîDCDCEN=1
  65   1        //µÈ´ýDCDCÆô¶¯  
  66   1        do
  67   1          {
  68   2          delay_ms(5);
  69   2          SystemTelemHandler();
  70   2          if(Data.OutputVoltage>7.1)break; //Êä³öµçÑ¹Õý³£
  71   2          retry--;
  72   2          }
  73   1        while(retry>0);
  74   1        //DCDCÆô¶¯Ê§°Ü
  75   1        if(retry==0)
  76   1          {
  77   2          DCDCEN=0; //ÁîDCDCEN=0
  78   2          ErrCode=Fault_DCDCFailedToStart;
  79   2          if(CurrentMode->ModeIdx!=Mode_Fault)SwitchToGear(Mode_Fault);  //Ö¸Ê¾¹ÊÕÏ·¢Éú
  80   2          return;
  81   2          }
  82   1        //½øÐÐÊä³öEN¿ØÖÆµÄ¼ì²â
  83   1        retry=100; //¸´Î»ÑÓÊ±µÈ´ý
  84   1        DCDCEN=0; //ÁîDCDCEN=0
  85   1        delay_ms(20); //ÑÓ³Ù20ms
  86   1        PWM_ForceSetDuty(0); //¹Ø±ÕPWMDAC
  87   1        do
  88   1          {
  89   2          SystemTelemHandler();
  90   2          delay_ms(10);
  91   2          //¸üÐÂÊý¾Ý
  92   2          for(i=4;i>0;i--)LastOutput[i]=LastOutput[i-1];  
  93   2          LastOutput[0]=Data.OutputVoltage;
  94   2          //ÇóÆ½¾ù  
  95   2          buf=0;
  96   2          for(i=0;i<5;i++)buf+=LastOutput[i];
  97   2          buf/=(float)5;      
  98   2          //ÇóÊý¾ÝÀïÃæÃ¿×éÊý¾ÝµÄ²î¾à
  99   2          Err=0;  
 100   2          for(i=0;i<5;i++)Err+=fabs(buf-LastOutput[i]);
 101   2          if(retry<93&&Err>0.5)break; //Êä³öµçÑ¹Õý³£Ë¥¼õÖÐ£¬µôµç
 102   2          retry--;
 103   2          }
 104   1        while(retry>0);
 105   1        //DCDCÍ£Ö¹Ê§°Ü£¬EN²»ÊÜ¿Ø£¬±¨´í
 106   1        if(retry==0)
 107   1          {
 108   2          ErrCode=Fault_DCDCENOOC;
 109   2          if(CurrentMode->ModeIdx!=Mode_Fault)SwitchToGear(Mode_Fault);  //Ö¸Ê¾¹ÊÕÏ·¢Éú
 110   2          }
 111   1        } 
 112            
 113          //Êä³öÍ¨µÀ½øÈëÐÝÃßµÄ²Ù×÷
 114          void OutputChannel_DeInit(void)
 115            {
C51 COMPILER V9.60.0.0   OUTPUTCHANNEL                                                     11/15/2024 17:30:59 PAGE 3   

 116   1        //¸´Î»µçÁ÷»º³åÆ÷
 117   1        Current=0;
 118   1        CurrentBuf=0;
 119   1        //¹Ø±ÕËùÓÐÊä³ö
 120   1        RevPGate=0;
 121   1        DCDCEN=0;
 122   1        LShuntSEL=0;
 123   1        HShuntSEL=0;  
 124   1        }
 125            
 126          //ÄÚ²¿ÓÃÓÚ¼ÆËãPWMDACÕ¼¿Õ±ÈµÄº¯Êý  
 127          static float Duty_Calc(float ShuntmOhm,int Current,float Offset)
 128            {
 129   1        float buf;
 130   1        buf=(float)Current*ShuntmOhm; //ÊäÈë´«½øÀ´µÄµçÁ÷(mA)²¢³ËÒÔ¼ìÁ÷µç×è×èÖµ(mR)µÃµ½ÔË·Å¶ËÕû¶¨µçÑ¹(uV)
 131   1        buf/=(float)1000; //uV×ªmV
 132   1        buf/=((float)VdivDownResK/(float)(VdivUpResK+VdivDownResK+PWMDACResK)); //½«ÔË·Å¶ËÕû¶¨µçÑ¹³ýÒÔµç×èµÄ·ÖÑ¹±
             -ÈÀýµÃµ½DAC¶ËµÄµçÑ¹
 133   1        buf*=Offset; //³ËÒÔ½ÃÕýÏµÊýÐÞÕýµçÁ÷
 134   1        buf/=Data.MCUVDD*(float)1000; //¼ÆËã³öÄ¿±êDACÊä³öµçÑ¹ºÍPWMDAC»º³åÆ÷¹©µçµçÑ¹(MCUVDD)Ö®¼äµÄ±ÈÖµ
 135   1        buf*=100; //×ª»»Îª°Ù·Ö±È
 136   1        //½øÐÐÏÞ·ùºÍ½á¹ûÊä³ö  
 137   1        if(buf>100)buf=100;
 138   1        if(buf<0)buf=0;
 139   1        return buf;
 140   1        }
 141            
 142          //Êä³öÍ¨µÀ¼ÆËã
 143          void OutputChannel_Calc(void)
 144            {
 145   1        //ÑÓÊ±ÆôÓÃDCDC  
 146   1        if(IsEnableDCDCCounter&&!IsNeedToUploadPWM) 
 147   1          {
 148   2          IsEnableDCDCCounter--;
 149   2          if(!IsEnableDCDCCounter)DCDCEN=1; //Ê±¼äµ½£¬´ò¿ªDCDC
 150   2          }
 151   1        //±ÜÃâÎÞÐ§µÄÖØ¸´¼ÆËã
 152   1        if(CurrentBuf==Current)return;
 153   1        CurrentBuf=Current;
 154   1        //µçÁ÷Ð¡ÓÚµÈÓÚ0£¬¹Ø±ÕËùÓÐÊä³ö
 155   1        if(CurrentBuf<=0)
 156   1          {
 157   2          if(CurrentMode->ModeIdx!=Mode_Strobe) //·Ç±¬ÉÁÄ£Ê½ÏÂÇåÁãPWMDAC»ù×¼Êä³ö
 158   2            {
 159   3            PWMDuty=0;
 160   3            IsNeedToUploadPWM=1;
 161   3            }
 162   2          RevPGate=CurrentBuf==-1?1:0;
 163   2          DCDCEN=0;
 164   2          LShuntSEL=0;
 165   2          HShuntSEL=0;
 166   2          }
 167   1        //Ê¹ÓÃ¸¨ÖúÍ¨µÀ
 168   1        else if(CurrentBuf<AUXChannelImax)
 169   1          {
 170   2          PWMDuty=Duty_Calc(AUXChannelShuntmOhm,CurrentBuf,LowShuntIOffset);
 171   2          RevPGate=Data.RawBattVolt<9.5?1:0;   //µÍÊä³öµçÁ÷ÇÒÊäÈë¹¦ÂÊ²»´óÊ±ÏÂ¹Ø±Õ·À·´½ÓFET½ÚÊ¡ÄÜÁ¿
 172   2          if(!DCDCEN)IsEnableDCDCCounter=PWMDACSettleDelay; //Èç¹ûµ±Ç°DCDCÊÇ¹Ø±Õ×´Ì¬ÔòÑÓÊ±Ò»¶ÎÊ±¼äÔÙ´ò¿ª
 173   2          LShuntSEL=1;  
 174   2          HShuntSEL=0;  //Æô¶¯DCDC£¬Ñ¡ÔñµÍÁ¿³ÌÍ¨µÀ
 175   2          IsNeedToUploadPWM=1; //ÐèÒª¸üÐÂPWMÊä³ö
 176   2          }
C51 COMPILER V9.60.0.0   OUTPUTCHANNEL                                                     11/15/2024 17:30:59 PAGE 4   

 177   1        //µçÁ÷´óÓÚ¸¨ÖúÍ¨µÀÉÏÏÞ£¬Ê¹ÓÃÖ÷Í¨µÀ
 178   1        else
 179   1          {
 180   2          PWMDuty=Duty_Calc(MainChannelShuntmOhm,CurrentBuf,HighShuntIOffset);
 181   2          RevPGate=1;   //Ö÷Êä³öÆôÓÃ£¬´ò¿ª·À·´½ÓFETÌá¸ßÄÜÐ§
 182   2          if(CurrentMode->ModeIdx==Mode_Strobe)DCDCEN=1; //±¬ÉÁÄ£Ê½ÐèÒªºÜ¿ìµÄÏìÓ¦ËÙ¶ÈËùÒÔÖ±½Ó´ò¿ªDCDC
 183   2          else if(!DCDCEN)IsEnableDCDCCounter=PWMDACSettleDelay; //ÆäÓàµ²Î»ÔòÑÓÊ±Ò»¶ÎÊ±¼äÔÙ´ò¿ª
 184   2          LShuntSEL=0;  
 185   2          HShuntSEL=1;  //Æô¶¯DCDC£¬Ñ¡Ôñ¸ßÁ¿³ÌÍ¨µÀ
 186   2          IsNeedToUploadPWM=1; //ÐèÒª¸üÐÂPWMÊä³ö
 187   2          }
 188   1        }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1186    ----
   CONSTANT SIZE    =     20    ----
   XDATA SIZE       =      5      28
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      21
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
