C51 COMPILER V9.60.0.0   TAILKEY                                                           11/16/2024 15:17:14 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE TAILKEY
OBJECT MODULE PLACED IN .\Objects\TailKey.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Hardware\TailKey.c OMF2 OPTIMIZE(9,SPEED) BROWSE INCDIR(.\include;.\StdD
                    -river\inc;.\Hardware) DEBUG PRINT(.\Listings\TailKey.lst) TABS(2) OBJECT(.\Objects\TailKey.obj)

line level    source

   1          #include "PinDefs.h"
   2          #include "cms8s6990.h"
   3          #include "GPIO.h"
   4          #include "delay.h"
   5          #include "TailKey.h"
   6          #include "ADCCfg.h"
   7          #include "PWMCfg.h"
   8          
   9          //外部声明
  10          void SystemPeripheralCTRL(bit IsEnable);//禁用/启用所有系统外设
  11          static xdata char TailKeyCount=0;
  12          xdata char TailKeyTIM=TailKeyRelTime+1;
  13          static xdata bool IsTailKeyPressed=false;
  14          
  15          //内部全局
  16          static volatile unsigned char IsEnterLowPowerMode=0xFF;
  17          
  18          //比较器中断
  19          void ACMP_IRQHandler(void)  interrupt ACMP_VECTOR 
  20          {
  21   1        HShuntSelIOP&=~(0x01<<HShuntSelIOx);
  22   1        LShuntSelIOP&=~(0x01<<LShuntSelIOx);
  23   1        RevProtIOP&=~(0x01<<RevProtIOx);
  24   1        DCDCENIOP&=~(0x01<<DCDCENIOx); //立即拉掉DCDCEN
  25   1        RedLEDIOP&=~(0x01<<RedLEDIOx);
  26   1        GreenLEDIOP&=~(0x01<<GreenLEDIOx); //令LED立即熄灭
  27   1        IsEnterLowPowerMode=0x00;
  28   1        //响应结束
  29   1        CNIF=0; 
  30   1      } 
  31          
  32          //尾部开关初始化
  33          void TailKey_Init(void)
  34            {
  35   1        C0CON0=0x09; //比较器调节模式禁止，正输入为C0P1，负输入为内部REF  
  36   1        C0CON2=0x00; //比较器配置为禁止滤波功能，正输出极性
  37   1        C0HYS=0x00; //禁用迟滞
  38   1        CNVRCON=0x39; //比较器负向输入的基准电压为内部1.2V带隙基准按照11/20比例分压得到0.66V
  39   1        CNFBCON=0x05; //使能比较器0的刹车功能，在负边沿时禁止PWM输出
  40   1        C0CON0|=0x80; //令C0EN=1，比较器开始运行
  41   1        
  42   1        //使能中断
  43   1        CNIF=0; //打开比较器中断
  44   1        EIP1=0x80; //比较器中断必须实时响应所以设置为极高优先级
  45   1        CNIE=0x01; //使能比较器中断
  46   1        }
  47          
  48          //获取尾按按下的次数
  49          char GetTailKeyCount(void)
  50            {
  51   1        char buf;
  52   1        if(!IsTailKeyPressed)return 0;
  53   1        else 
  54   1          {
C51 COMPILER V9.60.0.0   TAILKEY                                                           11/16/2024 15:17:14 PAGE 2   

  55   2          buf=TailKeyCount;
  56   2          TailKeyCount=0;
  57   2          IsTailKeyPressed=false;
  58   2          }
  59   1        return buf;
  60   1        } 
  61          
  62          //尾按计时器
  63          void TailKeyCounter(void)
  64            {
  65   1        if(TailKeyTIM<TailKeyRelTime)TailKeyTIM++;
  66   1        else if(TailKeyTIM==TailKeyRelTime)
  67   1          {
  68   2          TailKeyTIM++;
  69   2          if(TailKeyCount>0)IsTailKeyPressed=true;
  70   2          }
  71   1        } 
  72            
  73          //尾按逻辑处理  
  74          void TailKey_Handler(void)
  75            {
  76   1        if(IsEnterLowPowerMode)return;
  77   1        //循环等待按钮重新接通恢复供电
  78   1        do
  79   1          {
  80   2          delay_ms(5);
  81   2          IsEnterLowPowerMode<<=1;
  82   2          if(C0CON1&0x80)IsEnterLowPowerMode++;
  83   2          }     
  84   1        while(IsEnterLowPowerMode!=0xFF);
  85   1        //恢复供电，进行按键逻辑处理
  86   1        PWM_Enable(); //重新使能PWM   
  87   1        TailKeyCount++;
  88   1        TailKeyTIM=0;  //尾按按键按下，发生事件复位计时器
  89   1        }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    218    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      3    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
