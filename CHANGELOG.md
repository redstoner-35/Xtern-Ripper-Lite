# 更新日志

## [1.1.0.4] - DEC-22-2024 12:20

### 固件勘误

+ 修复侧按战术点射模式松开手无法正常熄灭的bug
+ 修复手电点亮时通过尾按开关换挡后，侧按指示灯永远保持熄灭无法亮起的bug
+ 修复侧按战术点射模式在自动降档后错误的触发换挡反复循环的bug
+ 调整温控PI环积分器的运算速度和温控参数解决温控降档亮度不稳定的问题
+ 修复在无极调光模式下用户通过尾按退出调整的条件过于严格的问题
+ 将温控积分器的量程上限修改为由IDE自动计算避免用户填入非法值，并增加对温控系统设置值进行检查的条件编译语句在非法值时阻止编译成功。

### 硬件勘误

本次没有硬件勘误内容

### 固件更新

+ 新增手电在任意状态（关机和开机）均可通过双击+长按操作查询电量的功能
+ 新增非极亮挡位的独立温控设置，解决手电在非极亮挡位过于烫手且持续高亮不降档导致续航过短的问题。
+ 对代码内部分局部变量的类型进行调整（从int调整为char）减少ROM占用并提高代码执行速度。
+ 使用新的`QueryCurrentGearILED()`函数获取LED电流避免直接调用`CurrentMode`结构体指针内的`ModeIdx`成员所引起的电流合法性问题并减少ROM占用。
+ 将消除系统错误状态的代码统一为使用新的`ClearError()`函数,优化ROM占用。
+ 将温控系统中需要实现温度滞回控制的几个标志位统一使用`TempSchmittTrigger()`函数实现温度相关的滞回控制。

### 硬件更新

本次没有硬件更新内容

### 其余更新

+ 将PCB工程文件内的固件同步到固件源码的最新build
+ 在Readme的操作逻辑章节内增加如何在手电处于点亮状态时进入到电量查询模式的提示。
+ 在Readme的固件编译注意事项内增加新增的条件编译语句检查出异常时报告的错误的描述
+ 将Readme文件内关于MCU配置的章节中，`WAKEUP_WAITTIME`这个配置项修改为100uS（解决有时候固件在休眠状态唤醒时对按键响应不正确的bug）

## [1.1.0.3] - DEC-15-2024 19:04

### 固件勘误

+ 修复在极低电量时爆闪和SOS挡位因为低电量保护机制不能正确工作的bug
+ 修复即使电量极低也可以通过正向尾按操作强制打开极亮模式的bug
+ 修复开机时侧按LED会有一次无意义闪烁引起串数显示用户会误判的bug
+ 在低电量时禁用尾按监测功能以修复极低电量时手电会出现异常跳档的bug
+ 修复通过尾按开机时从开关按下到手电主灯点亮延迟过大影响战术开关点射体验的bug
+ 修复装入电池时的上电显示不能正确显示电池电量的bug
+ 修正[OutputChannel.h](/Firmware/include/OutputChannel.h)内负责定义辅助通道最大电流的`AUXChannelImax`宏的数值为120mA
    计算公式为：(MCUVDD*(RPWMDACBot/(RPWMDACBot+RPWMDACTop)))/RShuntOhm=(5.0V*(1.5KΩ/(1.5KΩ+110KΩ)))/0.5Ω=0.134529A，考虑到MCUVDD可能存在误差，因此取120mA的最大值预留17mV的PWMDAC输出摆幅避免PWMDAC饱和。

### 硬件勘误

本次没有硬件勘误内容

### 固件更新

+ 进一步降低侧按指示LED的亮度避免亮度过高影响使用观感，同时降低MCU供电LDO的负载。
+ 增加爆闪和SOS的低电量电流限制，提升SOS续航的同时避免电池电量低时压降过大导致固件出现异常换挡的现象。
+ 移除[OutputChannel.c](/Firmware/Hardware/OutputChannel.c)内没有作用的`OutputChannel_DeInit()`函数，节省ROM空间。

### 硬件更新

本次没有硬件更新内容

### 其余更新

+ 将PCB工程文件内的固件同步到固件源码的最新build
+ 修正Readme文件内关于配置电阻设置章节中，`154K，147K，56K，47K`这四个阻值的对应极亮电流为23A，匹配固件内的实际设置。
+ 修正Readme文件内关于操作逻辑章节的电流描述匹配新的固件设置(1A、2A、4A、8A)并更新操作逻辑的插图。
+ 在Readme章节内增加MCU的CONFGIG配置的内容



## [1.1.0.2] - DEC-14-2024 20:48

### 固件勘误

+ 将恒温PI环路的正误差响应阈值改为+2℃提高温控的响应速度。

### 硬件勘误

本次没有硬件勘误内容

### 固件更新

+ 将侧按指示LED的输出模式改为PWM允许程序根据需要降低侧按指示灯亮度，节约能量提高续航并解决指示灯过亮的问题
+ 将固件内负责SOS模式亮度生成的代码和对应的声明移动到新的`SOS.c`以及`SOS.h`文件内，方便后续进行代码的移植。
+ 增加在电池电量极低时每隔一段时间闪烁一次主灯提示用户电量接近耗尽的提示功能
+ 针对实际外壳的体感温度降低恒温温度至51℃避免外壳过于烫手

### 硬件更新

本次没有硬件更新内容

### 其余更新

+ 将PCB工程文件内的固件同步到固件源码的最新build
+ 更新readme内的装筒效果图到V1.1硬件的实际效果


## [1.1.0.1] - DEC-12-2024 20:36

### 固件勘误

+ 解决固件温控系统工作异常导致极亮过热关机的bug
+ 调整固件的侧按监测系统解决固件的侧按按键响应不灵敏的bug
+ 解决固件在进入深度休眠模式后因按键处理模块异常无法正常唤醒的bug
+ 解决固件在ADC配置时未正确配置运放反馈的监测引脚导致输出监测存在的异常

### 硬件勘误

本次没有硬件勘误内容

### 固件更新

+ 增加输出电流斜率限制功能，在极亮等电流较大的挡位切换过去时，缓慢增加电流避免电流过冲导致部分脆弱灯珠损坏。
+ 在模式结构体内增加每个挡位的补偿偏移，解决输出电流偏差大的问题
+ 移除针对热敏电阻的额外上电自检功能，改为主循环内监测。

### 硬件更新

+ 将FB注入部分运放相关的R14/R17电阻阻值更换为100Ω解决使用高量程通道+低输出功率时输出不稳定灯光闪烁的问题。
+ 将高量程通道检流电阻由原来的`BVT-V-R002-1.0`更换为深圳华讯高科的`ASR-M-3-R0015-1.0`。阻值减小0.5mΩ降低3V 22A输出的损耗
+ 更新BOM表和[PCB工程文件中的原理图](/MainPCB/main.SchDoc)、[PCB文件](/MainPCB/PCB1.PcbDoc)以及PDF格式的[参考原理图](/MainPCB/Schematic.pdf)应用上述更改

### 其余更新

+ 对Readme文件进行调整，移除错误指示章节中上电错误提示的内容
+ 更新Readme文件内的成品图片为V1.1版本硬件
+ 将PCB工程文件内的固件同步到固件源码的最新build



## [1.1.0.0] - DEC-6-2024 21:45

### 固件勘误

+ 解决基于中断的正向尾按按压次数的监测例程响应不稳定存在随机性导致的换挡异常。
+ 移除WDT相关的配置代码以禁用WDT定时器，解决使用正向开关时看门狗定时器引起的固件异常行为（错误的报告Error_MPU_Hang，异常重启导致正向开关识别异常等）
+ 解决固件在进入故障保护模式并断开输出后，如果给驱动重新上电时驱动会尝试开机并回到上一个挡位，造成故障扩大的问题。
+ 对输出电流合成和输出级配置的代码进行优化解决使用3V LED时驱动在低亮和月光挡位的亮度过冲并可能引起LED烧毁的问题。
+ 解决正向开关模式下换挡的记忆延迟过大导致的换挡操作异常（表现为使用单击+按下的换挡操作需要保持手电点亮几秒才能正确换挡）
+ 解决固件的输出状态监测系统无法正确响应LED开路事件并错误的报告为配置电阻配置错误的问题。

### 硬件勘误

+ 将输出电感更换为'XAL1010-681MEB'以解决输出滤波器的穿越频率过低导致电压环路在3V下失稳的问题，同时提高3V下的效率。
+ 移除原理图和BOM表内关于输出电感的错误选型替换提示（XAL1060-681MEB不可以使用FEXL1060A-R68M进行替代，这俩玩意尺寸差一大截装不上去）
+ 修复PCB文件中底层线路层GND铺铜不完整的问题
+ 移除掉PCB工程源文件内的预览缓存等垃圾文件

### 固件更新

+ 对配置电阻识别功能的代码进行重构支持更细分的LED类型选择和极亮电流配置以及电池数目选择，并移除不合理的配置（无法全程恒流等）
+ 当配置电阻配置为2串模式时，自动开启9.99V量程的高分辨率显示模式提高2串用户的电池电压查询精度。
+ 增加电压显示部分的电压合法性监测代码，避免电压显示模块在输入电压异常（例如2串模式的驱动强制输入高于10V的电压等）时显示错误的信息并在此类情况发生时通过红灯快闪三次提示。
+ 通过配置电阻启用正向尾按开关的监测模块时，即使手电配置为关闭状态下也可以通过正向尾按换挡的操作直接打开手电而无需通过侧按打开手电后才能使用尾按功能。

### 硬件更新

+ 更新FB注入部分的负反馈电阻R12和反馈电容C13的参数，调整环路带宽提高3V下的效率。
+ 将SIC431的输出OCP设置电阻R3(MODE1)更新为499K将SIC431的OCP设置为32A，确保22A输出时可以跑满电流。
+ 增加SW节点的RC吸收器用于吸收SW节点的高频振铃改善EMI性能并增加芯片的可靠性。

### 其余更新

+ 对Readme文件进行调整，将错误指示相关的内容独立为一个子章节并增加上电时的错误指示和对应描述
+ 将新增的高精度电压查询功能和更新的配置电阻设置指引同步到Readme的对应章节
+ 在Readme文件内的调试章节中新增关闭尾按功能，仅支持侧部电子开关的纯侧按固件的相关描述
+ 更新PCB工程文件夹内的[预编译固件文件](/MainPCB/Firmware.hex)和最新源代码的编译结果同步
+ 在PCB工程文件夹内增加[仅支持侧部按键的预编译固件文件](/MainPCB/Firmware-ESwitch.hex)

----------------------------------------------------------------------------------------------------------------------------------
© redstoner_35 @ 35's Embedded Systems Inc.  2024