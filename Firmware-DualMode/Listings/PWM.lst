C51 COMPILER V9.60.0.0   PWM                                                               11/16/2024 15:17:13 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE PWM
OBJECT MODULE PLACED IN .\Objects\PWM.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Hardware\PWM.c OMF2 OPTIMIZE(9,SPEED) BROWSE INCDIR(.\include;.\StdDrive
                    -r\inc;.\Hardware) DEBUG PRINT(.\Listings\PWM.lst) TABS(2) OBJECT(.\Objects\PWM.obj)

line level    source

   1          #include "cms8s6990.h"
   2          #include "PinDefs.h"
   3          #include "GPIO.h"
   4          #include "PWMCfg.h"
   5          
   6          //全局变量
   7          xdata float PWMDuty;
   8          static bit IsPWMLoading; //PWM正在加载中
   9          static bit IsNeedToEnableOutput; //是否需要启用输出
  10          bit IsNeedToUploadPWM; //是否需要更新PWM
  11          
  12          //关闭PWM定时器
  13          void PWM_DeInit(void)
  14            {
  15   1        //配置为普通GPIO
  16   1        GPIO_SetMUXMode(PWMDACIOG,PWMDACIOx,GPIO_AF_GPIO);  
  17   1        //设置为输出0
  18   1        GPIO_WriteBit(PWMDACIOG,PWMDACIOx,0); 
  19   1        //关闭PWM模块
  20   1        PWMOE=0x00;
  21   1        PWMCNTE=0x00;
  22   1        PWM01PSC=0x00;  //关闭PWM计数器
  23   1        }
  24          
  25          //上传PWM值
  26          static void UploadPWMValue(void)  
  27            {
  28   1        PWMLOADEN=0x01; //加载通道0的PWM值
  29   1        while(PWMLOADEN!=0); //等待加载结束
  30   1        }
  31          
  32          //PWM定时器初始化
  33          void PWM_Init(void)
  34            {
  35   1        GPIOCfgDef PWMInitCfg;
  36   1        //设置结构体
  37   1        PWMInitCfg.Mode=GPIO_Out_PP;
  38   1        PWMInitCfg.Slew=GPIO_Slow_Slew;   
  39   1        PWMInitCfg.DRVCurrent=GPIO_High_Current; //推PWMDAC，不需要很高的上升斜率
  40   1        //配置GPIO
  41   1        GPIO_WriteBit(PWMDACIOG,PWMDACIOx,0);
  42   1        GPIO_ConfigGPIOMode(PWMDACIOG,GPIOMask(PWMDACIOx),&PWMInitCfg); 
  43   1        //启用复用功能
  44   1        GPIO_SetMUXMode(PWMDACIOG,PWMDACIOx,GPIO_AF_PWMCH0);
  45   1        //配置PWM发生器
  46   1        PWMCON=0x00; //PWM通道为六通道独立模式，向下计数，关闭非对称计数功能  
  47   1        PWMOE=0x01; //打开PWM输出通道0
  48   1        PWM01PSC=0x01;  //打开预分频器和计数器时钟 
  49   1        PWM0DIV=0xff;   //令Fpwmcnt=Fsys=48MHz(不分频)
  50   1        PWMPINV=0x00; //所有通道均设置为正常输出模式
  51   1        PWMCNTM=0x01; //通道0配置为自动加载模式
  52   1        PWMCNTCLR=0x01; //初始化PWM的时候复位定时器
  53   1        PWMDTE=0x00; //关闭死区时间
  54   1        PWMMASKD=0x00; 
C51 COMPILER V9.60.0.0   PWM                                                               11/16/2024 15:17:13 PAGE 2   

  55   1        PWMMASKE=0x01; //PWM掩码功能启用，默认状态下禁止通道0输出
  56   1        //配置周期数据
  57   1        PWMP0H=(PWMStepConstant>>8)&0xFF;
  58   1        PWMP0L=PWMStepConstant&0xFF;  
  59   1        //配置占空比数据
  60   1        PWMD0H=0;
  61   1        PWMD0L=0; 
  62   1        //初始化变量
  63   1        PWMDuty=0;
  64   1        IsPWMLoading=0; 
  65   1        IsNeedToUploadPWM=0;
  66   1        //启用PWM
  67   1        PWM_Enable();
  68   1        UploadPWMValue();
  69   1        }
  70          
  71          //PWM强制设置占空比
  72          void PWM_ForceSetDuty(bit IsEnable)
  73            {
  74   1        PWMD0H=0x01;
  75   1        PWMD0L=IsEnable?0xFF:0;     
  76   1        UploadPWMValue(); //立即上传PWM值
  77   1        PWMMASKE=IsNeedToEnableOutput?0x00:0x01;  //设置寄存器打开输出
  78   1        } 
  79            
  80          //根据PWM结构体内的配置进行输出
  81          void PWM_OutputCtrlHandler(void)  
  82            {
  83   1        int value;
  84   1        float buf;
  85   1        //判断是否需要加载的逻辑运算
  86   1        if(!IsNeedToUploadPWM)return; //不需要加载
  87   1        else if(IsPWMLoading) //当次加载运行中
  88   1          {
  89   2          if(!PWMLOADEN)//加载寄存器复位为0，表示加载成功
  90   2             {
  91   3             PWMMASKE=IsNeedToEnableOutput?0x00:0x01; //更新PWMMASKE寄存器根据输出状态启用对应的通道
  92   3             IsNeedToUploadPWM=0;
  93   3             IsPWMLoading=0;  //正在加载状态为清除
  94   3             }
  95   2          return;
  96   2          }
  97   1        //PWM占空比限制
  98   1        if(PWMDuty>100)PWMDuty=100;
  99   1        if(PWMDuty<0)PWMDuty=0;
 100   1        //配置装载数值
 101   1        IsNeedToEnableOutput=buf?1:0; //是否需要启用输出
 102   1        buf=PWMDuty*(float)PWMStepConstant;
 103   1        buf/=(float)100;
 104   1        value=(int)buf;
 105   1        PWMD0H=(value>>8)&0xFF;
 106   1        PWMD0L=value&0xFF;      
 107   1        //PWM寄存器数值已装入，应用数值   
 108   1        IsPWMLoading=1; //标记加载过程进行中
 109   1        PWMLOADEN=0x01; //开始加载
 110   1        }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    404    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      4    ----
C51 COMPILER V9.60.0.0   PWM                                                               11/16/2024 15:17:13 PAGE 3   

   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       7
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3       1
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
